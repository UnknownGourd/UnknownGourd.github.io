"undefined"==typeof Iuppiter&&(Iuppiter={version:"$Revision: 3026 $".substring(11).replace(" $","")}),Iuppiter.toByteArray=function(t){var e,i,s=[];for(e=0;e<t.length;e++)(i=t.charCodeAt(e))<=127?s.push(i):i<=2047?(s.push(i>>6|192),s.push(63&i|128)):i<=65535?(s.push(i>>12|224),s.push(i>>6&63|128),s.push(63&i|128)):(s.push(i>>18|240),s.push(i>>12&63|128),s.push(i>>6&63|128),s.push(63&i|128));return s},Iuppiter.Base64={CA:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",CAS:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",IA:new Array(256),IAS:new Array(256),init:function(){var t;for(t=0;t<256;t++)Iuppiter.Base64.IA[t]=-1,Iuppiter.Base64.IAS[t]=-1;for(t=0,iS=Iuppiter.Base64.CA.length;t<iS;t++)Iuppiter.Base64.IA[Iuppiter.Base64.CA.charCodeAt(t)]=t,Iuppiter.Base64.IAS[Iuppiter.Base64.CAS.charCodeAt(t)]=t;Iuppiter.Base64.IA["="]=Iuppiter.Base64.IAS["="]=0},encode:function(t,e){var i,s,n,o,a,r,h,l,u,c;for(i=e?Iuppiter.Base64.CAS:Iuppiter.Base64.CA,a=(o=(n=t.constructor==Array?t:Iuppiter.toByteArray(t)).length)/3*3,r=(o-1)/3+1<<2,s=new Array(r),h=0,l=0;h<a;)c=(255&n[h++])<<16|(255&n[h++])<<8|255&n[h++],s[l++]=i.charAt(c>>18&63),s[l++]=i.charAt(c>>12&63),s[l++]=i.charAt(c>>6&63),s[l++]=i.charAt(63&c);return(u=o-a)>0&&(c=(255&n[a])<<10|(2==u?(255&n[o-1])<<2:0),s[r-4]=i.charAt(c>>12),s[r-3]=i.charAt(c>>6&63),s[r-2]=2==u?i.charAt(63&c):"=",s[r-1]="="),s.join("")},decode:function(t,e){var i,s,n,o,a,r,h,l,u,c,d,f,p,g,m,y;for(i=e?Iuppiter.Base64.IAS:Iuppiter.Base64.IA,t.constructor==Array?(n=t,a=!0):(n=Iuppiter.toByteArray(t),a=!1),r=0,h=(o=n.length)-1;r<h&&i[n[r]]<0;)r++;for(;h>0&&i[n[h]]<0;)h--;for(l="="==n[h]?"="==n[h-1]?2:1:0,d=(6*((u=h-r+1)-(c=o>76?("\r"==n[76]?u/78:0)<<1:0))>>3)-l,s=new Array(d),f=0,p=0,eLen=d/3*3;f<eLen;)g=i[n[r++]]<<18|i[n[r++]]<<12|i[n[r++]]<<6|i[n[r++]],s[f++]=g>>16&255,s[f++]=g>>8&255,s[f++]=255&g,c>0&&19==++p&&(r+=2,p=0);if(f<d){for(g=0,m=0;r<=h-l;m++)g|=i[n[r++]]<<18-6*m;for(y=16;f<d;y-=8)s[f++]=g>>y&255}if(a)return s;for(g=0;g<s.length;g++)s[g]=String.fromCharCode(s[g]);return s.join("")}},Iuppiter.Base64.init(),NBBY=8,MATCH_BITS=6,MATCH_MIN=3,MATCH_MAX=(1<<MATCH_BITS)+(MATCH_MIN-1),OFFSET_MASK=(1<<16-MATCH_BITS)-1,LEMPEL_SIZE=256,Iuppiter.compress=function(t){var e,i,s,n,o,a,r,h,l=[],u=0,c=0,d=1<<NBBY-1,f=new Array(LEMPEL_SIZE);for(h=0;h<LEMPEL_SIZE;h++)f[h]=3435973836;for(t.constructor==Array?e=t:e=Iuppiter.toByteArray(t),i=e.length;u<i;){if((d<<=1)==1<<NBBY){if(c>=i-1-2*NBBY){for(o=i,u=0,c=0;o;o--)l[c++]=e[u++];return l}d=1,n=c,l[c++]=0}if(u>i-MATCH_MAX)l[c++]=e[u++];else if(a=u-f[r=(e[u]+13^e[u+1]-13^e[u+2])&LEMPEL_SIZE-1]&OFFSET_MASK,f[r]=u,(s=u-a)>=0&&s!=u&&e[u]==e[s]&&e[u+1]==e[s+1]&&e[u+2]==e[s+2]){for(l[n]|=d,o=MATCH_MIN;o<MATCH_MAX&&e[u+o]==e[s+o];o++);l[c++]=o-MATCH_MIN<<NBBY-MATCH_BITS|a>>NBBY,l[c++]=a,u+=o}else l[c++]=e[u++]}return l},Iuppiter.decompress=function(t,e){var i,s,n,o,a,r,h,l,u,c=[],d=0,f=0,p=1<<NBBY-1;for(t.constructor==Array?(i=t,l=!0):(i=Iuppiter.toByteArray(t),l=!1),l=void 0!==e&&e,s=i.length,u=function(){if(l)return c;for(h=0;h<f;h++)c[h]=String.fromCharCode(c[h]);return c.join("")};d<s;)if((p<<=1)==1<<NBBY&&(p=1,o=i[d++]),o&p){if(a=(i[d]>>NBBY-MATCH_BITS)+MATCH_MIN,r=(i[d]<<NBBY|i[d+1])&OFFSET_MASK,d+=2,!((n=f-r)>=0))return u();for(;--a>=0;)c[f++]=c[n++]}else c[f++]=i[d++];return u()},window.Modernizr=function(t,e,i){var s,n,o={},a=e.documentElement,r="modernizr",h=e.createElement(r),l=h.style,u="Webkit Moz O ms MS".split(" "),c="Webkit Moz O ms MS".toLowerCase().split(" "),d={},f=[],p=f.slice,g=function(t,i,s,n){var o,h,l,u,c=e.createElement("div"),d=e.body,f=d||e.createElement("body");if(parseInt(s,10))for(;s--;)(l=e.createElement("div")).id=n?n[s]:r+(s+1),c.appendChild(l);return o=["&#173;",'<style id="s',r,'">',t,"</style>"].join(""),c.id=r,(d?c:f).innerHTML+=o,f.appendChild(c),d||(f.style.background="",f.style.overflow="hidden",u=a.style.overflow,a.style.overflow="hidden",a.appendChild(f)),h=i(c,t),d?c.parentNode.removeChild(c):(f.parentNode.removeChild(f),a.style.overflow=u),!!h},m={}.hasOwnProperty;function y(t){l.cssText=t}function v(t,e){return typeof t===e}function w(t,e){for(var s in t){var n=t[s];if(!~(""+n).indexOf("-")&&l[n]!==i)return"pfx"!=e||n}return!1}function x(t,e,s){var n=t.charAt(0).toUpperCase()+t.slice(1),o=(t+" "+u.join(n+" ")+n).split(" ");return v(e,"string")||v(e,"undefined")?w(o,e):function(t,e,s){for(var n in t){var o=e[t[n]];if(o!==i)return!1===s?t[n]:v(o,"function")?o.bind(s||e):o}return!1}(o=(t+" "+c.concat(u).join(n+" ")+n).split(" "),e,s)}function b(t,e,i){return e?x(t,e,i):x(t,"pfx")}for(var S in n=v(m,"undefined")||v(m.call,"undefined")?function(t,e){return e in t&&v(t.constructor.prototype[e],"undefined")}:function(t,e){return m.call(t,e)},Function.prototype.bind||(Function.prototype.bind=function(t){var e=this;if("function"!=typeof e)throw new TypeError;var i=p.call(arguments,1),s=function(){if(this instanceof s){var n=function(){};n.prototype=e.prototype;var o=new n,a=e.apply(o,i.concat(p.call(arguments)));return Object(a)===a?a:o}return e.apply(t,i.concat(p.call(arguments)))};return s}),d.canvas=function(){var t=e.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))},d.canvastext=function(){return!(!o.canvas||!v(e.createElement("canvas").getContext("2d").fillText,"function"))},d.fontface=function(){var t;return g('@font-face {font-family:"font";src:url("https://")}',function(i,s){var n=e.getElementById("smodernizr"),o=n.sheet||n.styleSheet,a=o?o.cssRules&&o.cssRules[0]?o.cssRules[0].cssText:o.cssText||"":"";t=/src/i.test(a)&&0===a.indexOf(s.split(" ")[0])}),t},d.audio=function(){var t=e.createElement("audio"),i=!1;try{(i=!!t.canPlayType)&&((i=new Boolean(i)).ogg=t.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),i.mp3=t.canPlayType("audio/mpeg;").replace(/^no$/,""),i.wav=t.canPlayType('audio/wav; codecs="1"').replace(/^no$/,""),i.m4a=(t.canPlayType("audio/x-m4a;")||t.canPlayType("audio/aac;")).replace(/^no$/,""))}catch(t){}return i},d.localstorage=function(){try{return localStorage.setItem(r,r),localStorage.removeItem(r),!0}catch(t){return!1}},d.sessionstorage=function(){try{return sessionStorage.setItem(r,r),sessionStorage.removeItem(r),!0}catch(t){return!1}},d.xhr2=function(){return"FormData"in t},d.json=function(){return!!t.JSON&&!!JSON.parse},d.filereader=function(){return!!(t.File&&t.FileList&&t.FileReader)},d.xmlserializer=function(){return"XMLSerializer"in t},d.overridemimetype=function(){return!!(new XMLHttpRequest).overrideMimeType},d.vbarray=function(){return"VBArray"in t},d.blob=function(){var e=!1;try{if(e="Blob"in t){(e=new Boolean(e)).slice=!!b("slice",Blob.prototype,!1),e.builder=!!b("BlobBuilder",t,!1),e.url=!!b("URL",t,!1);try{var i=t[b("URL",t,!1)],s=i.createObjectURL(new Blob([0,0]),{autoRevoke:!1});e.revoke=!0,i.revokeObjectURL(s)}catch(t){e.revoke=!1}try{e.creator=!!new Blob}catch(t){e.creator=!1}}}catch(t){}return e},d.arraybuffer=function(){var e=!1;try{(e="ArrayBuffer"in t)&&((e=new Boolean(e)).dataview=!!b("Uint8Array",t,!1))}catch(t){}return e},d)n(d,S)&&(s=S.toLowerCase(),o[s]=d[S](),f.push((o[s]?"":"no-")+s));return o.addTest=function(t,e){if("object"==typeof t)for(var s in t)n(t,s)&&o.addTest(s,t[s]);else{if(t=t.toLowerCase(),o[t]!==i)return o;e="function"==typeof e?e():e,"undefined"!=typeof enableClasses&&enableClasses&&(a.className+=" "+(e?"":"no-")+t),o[t]=e}return o},y(""),h=null,o._version="2.6.2",o.testStyles=g,o._domPrefixes=c,o._cssomPrefixes=u,o.testProp=function(t){return w([t])},o.testAllProps=x,o.prefixed=b,o}(this,this.document),function(){var t=new Image;t.onerror=function(){Modernizr.addTest("datauri",function(){return!1})},t.onload=function(){Modernizr.addTest("datauri",function(){return 1==t.width&&1==t.height})},t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="}(),"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"function"!=typeof Array.prototype.remove&&(Array.prototype.remove=function(t,e){var i=this.slice((e||t)+1||this.length);return this.length=t<0?this.length+t:t,this.push.apply(this,i)}),"function"!=typeof Array.prototype.contains&&(Array.prototype.contains=function(t){return this.indexOf(t)>-1}),Array.prototype.destroy=function(t){var e=this.indexOf(t);e>=0&&this.remove(e)},function(){var t="undefined"!=typeof window?window:exports,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",i=function(){try{document.createElement("$")}catch(t){return t}}();t.btoa||(t.btoa=function(t){for(var s,n,o=0,a=e,r="";t.charAt(0|o)||(a="=",o%1);r+=a.charAt(63&s>>8-o%1*8)){if((n=t.charCodeAt(o+=.75))>255)throw i;s=s<<8|n}return r}),t.atob||(t.atob=function(t){if((t=t.replace(/=+$/,"")).length%4==1)throw i;for(var s,n,o=0,a=0,r="";n=t.charAt(a++);~n&&(s=o%4?64*s+n:n,o++%4)?r+=String.fromCharCode(255&s>>(-2*o&6)):0)n=e.indexOf(n);return r})}();var Sburb=function(t){return t.Room=function(t,e,i){this.name=t,this.width=e,this.height=i,this.sprites=[],this.effects=[],this.walkables=[],this.unwalkables=[],this.motionPaths=[],this.triggers=[],this.walkableMap=null,this.mapScale=4},t.Room.prototype.mapData=null,t.Room.prototype.blockSize=500,t.Room.prototype.addEffect=function(t){this.effects.push(t)},t.Room.prototype.addTrigger=function(t){this.triggers.push(t)},t.Room.prototype.addSprite=function(t){this.contains(t)||this.sprites.push(t)},t.Room.prototype.removeSprite=function(t){var e;for(e=0;e<this.sprites.length;e++)if(this.sprites[e]==t)return this.sprites.splice(e,1),!0;return!1},t.Room.prototype.addWalkable=function(t){this.walkables.push(t)},t.Room.prototype.addUnwalkable=function(t){this.unwalkables.push(t)},t.Room.prototype.addMotionPath=function(t,e,i,s,n,o,a){var r=new function(){this.path=t,this.xtox=e,this.xtoy=i,this.ytox=s,this.ytoy=n,this.dx=o,this.dy=a};this.motionPaths.push(r)},t.Room.prototype.removeWalkable=function(t){this.walkables.splice(this.walkables.indexOf(t),1)},t.Room.prototype.removeUnwalkable=function(t){this.unwalkables.splice(this.unwalkables.indexOf(t),1)},t.Room.prototype.removeMotionPath=function(t){for(var e=0;e<this.motionPaths.length;e++){if(this.motionPaths[e].name==t.name)return void this.motionPaths.splice(e,1)}},t.Room.prototype.enter=function(){if(this.walkableMap){var e=t.Map,i=e.width=this.walkableMap.width,s=e.height=this.walkableMap.height,n=e.getContext("2d");n.drawImage(this.walkableMap,0,0,i,s,0,0,i,s),this.mapData=n.getImageData(0,0,i,s).data}},t.Room.prototype.exit=function(){this.effects=[],this.mapData=null},t.Room.prototype.contains=function(t){for(var e=0;e<this.sprites.length;e++)if(this.sprites[e]==t)return!0;return!1},t.Room.prototype.update=function(){var t;for(t=0;t<this.sprites.length;t++)this.sprites[t].update(this);for(t=this.effects.length-1;t>=0;t--)this.effects[t].hasPlayed()?this.effects.splice(t,1):this.effects[t].update();for(t=this.triggers.length-1;t>=0;t--)this.triggers[t].tryToTrigger()&&this.triggers.splice(t,1)},t.Room.prototype.draw=function(){this.sortDepths();for(var t=0;t<this.sprites.length;t++)this.sprites[t].draw();for(t=0;t<this.effects.length;t++)this.effects[t].draw(0,0)},t.Room.prototype.sortDepths=function(){var t,e;for(t=1,e=1;t<this.sprites.length;e=++t){for(var i=this.sprites[e];e>0&&i.isBehind(this.sprites[e-1]);)this.sprites[e]=this.sprites[e-1],e--;this.sprites[e]=i}},t.Room.prototype.queryActions=function(t,e,i){for(var s=[],n=0;n<this.sprites.length;n++){var o=this.sprites[n];o!=t&&o.hitsPoint(e,i)&&(s=s.concat(o.getActions(t)))}return s},t.Room.prototype.queryActionsVisual=function(t,e,i){for(var s=[],n=0;n<this.sprites.length;n++){var o=this.sprites[n];o.isVisuallyUnder(e,i)&&(s=s.concat(o.getActions(t)))}return s},t.Room.prototype.isInBounds=function(t,e,i){var s=t.getBoundaryQueries(e,i),n=this.isInBoundsBatch(s);for(var o in n)if(!n[o])return!1;return!0},t.Room.prototype.isInBoundsBatch=function(t,e){if("object"!=typeof e)for(var i in e={},t)t.hasOwnProperty(i)&&(e[i]=!1);if(this.walkableMap)for(var s in t)if(t.hasOwnProperty(s)){var n=t[s],o=this.mapData,a=this.walkableMap.width,r=this.walkableMap.height;if(n.x<0||n.x>a*this.mapScale||n.y<0||n.y>r*this.mapScale)e[s]=!1;else{var h=4*(Math.round(n.x/this.mapScale)+Math.round(n.y/this.mapScale)*a);e[s]=!!o[h]}}for(var l=0;l<this.walkables.length;l++)this.walkables[l].queryBatchPos(t,e);for(l=0;l<this.unwalkables.length;l++)this.unwalkables[l].queryBatchNeg(t,e);return e},t.Room.prototype.getMoveFunction=function(t){var e=this.getMotionPath(t);if(e)return function(t,i){return{x:t*e.xtox+i*e.ytox+e.dx,y:t*e.xtoy+i*e.ytoy+e.dy}}},t.Room.prototype.getInverseMoveFunction=function(t){var e=this.getMotionPath(t);if(e)return function(t,i){t-=e.dx,i-=e.dy;var s=e.xtox*e.ytoy-e.xtoy*e.ytox;return s?{x:(t*e.ytoy-i*e.ytox)/s,y:(-t*e.xtoy+i*e.xtox)/s}:{x:0,y:0}}},t.Room.prototype.getMotionPath=function(t){for(i=0;i<this.motionPaths.length;i++){var e=this.motionPaths[i];if(e.path.query(t))return e}return null},t.Room.prototype.collides=function(t,e,i){for(var s=0;s<this.sprites.length;s++){var n=this.sprites[s];if(n.collidable&&t!=n&&t.collides(n,e,i))return n}return null},t.Room.prototype.serialize=function(t){t=(t=t.concat("\n<room name='"+this.name+"' width='"+this.width+"' height='"+this.height+(this.walkableMap?"' walkableMap='"+this.walkableMap.name:"")+(4!=this.mapScale?"' mapScale='"+this.mapScale:"")+"' >")).concat("\n<paths>");for(var e=0;e<this.walkables.length;e++){var i=this.walkables[e];t=t.concat("\n<walkable path='"+i.name+"'/>")}for(e=0;e<this.unwalkables.length;e++){var s=this.unwalkables[e];t=t.concat("\n<unwalkable path='"+s.name+"'/>")}for(e=0;e<this.motionPaths.length;e++){var n=this.motionPaths[e];t=t.concat("\n<motionpath path='"+n.path.name+"' xtox='"+n.xtox+"' xtoy='"+n.xtoy+"' ytox='"+n.ytox+"' ytoy='"+n.ytoy+"' dx='"+n.dx+"' dy='"+n.dy+"'/>")}t=(t=t.concat("\n</paths>")).concat("\n<triggers>");for(e=0;e<this.triggers.length;e++)t=this.triggers[e].serialize(t);t=t.concat("\n</triggers>");for(e=0;e<this.sprites.length;e++)t=this.sprites[e].serialize(t);return t=t.concat("\n</room>")},t.parseRoom=function(e,i,s){var n=e.attributes,o=new t.Room(n.getNamedItem("name").value,n.getNamedItem("width")?parseInt(n.getNamedItem("width").value):0,n.getNamedItem("height")?parseInt(n.getNamedItem("height").value):0),a=n.getNamedItem("mapScale");a&&(o.mapScale=parseInt(a.value));var r=n.getNamedItem("walkableMap");r&&(o.walkableMap=i[r.value],o.width||(o.width=o.walkableMap.width*o.mapScale),o.height||(o.height=o.walkableMap.height*o.mapScale)),t.serialLoadRoomSprites(o,e.getElementsByTagName("sprite"),s),t.serialLoadRoomSprites(o,e.getElementsByTagName("character"),s),t.serialLoadRoomSprites(o,e.getElementsByTagName("fighter"),s);var h=e.getElementsByTagName("paths");h.length>0&&t.serialLoadRoomPaths(o,h,i);var l=e.getElementsByTagName("triggers");return l.length>0&&t.serialLoadRoomTriggers(o,l,s),o},t}((Sburb=function(t){return t.Animation=function(e,i,s,n,o,a,r,h,l,u,c,d,f,p,g,m){if(this.sheet=i,this.sliced=!!p,this.x=s||0,this.y=n||0,this.rowSize=a||i.height,this.colSize=o||i.width,this.startPos=r||0,this.length=h||1,this.curInterval=0,this.curFrame=0,this.name=e,this.loopNum="number"==typeof u?u:-1,this.curLoop=0,this.followUp=c,this.flipX=!!d,this.flipY=!!f,p){this.numRows=m,this.numCols=g,this.sheets={};for(var y=0;y<this.numCols;y++)for(var v=0;v<this.numRows;v++){(i=t.assets[this.sheet+"_"+y+"_"+v])&&(this.sheets[y]||(this.sheets[y]={}),this.sheets[y][v]=i)}this.draw=this.drawSliced}else this.numRows=i.height/this.rowSize,this.numCols=i.width/this.colSize,this.draw=this.drawNormal;if("string"==typeof l)if(-1==l.indexOf(":"))this.frameInterval=parseInt(l);else{var w=l.split(",");this.frameIntervals={};for(var x=0;x<w.length;x++){var b=w[x].split(":");this.frameIntervals[parseInt(b[0])]=parseInt(b[1])}this.frameIntervals[0]||(this.frameIntervals[0]=1),this.frameInterval=this.frameIntervals[this.curFrame]}else this.frameInterval=l||1},t.Animation.prototype.nextFrame=function(){this.curFrame++,this.curFrame>=this.length&&(this.curLoop==this.loopNum?this.curFrame=this.length-1:(this.curFrame=0,this.loopNum>=0&&this.curLoop++)),this.frameIntervals&&this.frameIntervals[this.curFrame]&&(this.frameInterval=this.frameIntervals[this.curFrame])},t.Animation.prototype.update=function(){for(this.curInterval++;this.curInterval>this.frameInterval;)this.curInterval-=this.frameInterval,this.nextFrame()},t.Animation.prototype.drawNormal=function(e,i){var s=t.Stage,n=t.stage,o=s.offset?s.x:0,a=s.offset?s.y:0,r=s.width,h=s.height;this.flipX&&(o=-o-r,e=-e),this.flipY&&(a=-a-h,i=-i),e=Math.round((this.x+e)/s.scaleX)*s.scaleX,i=Math.round((this.y+i)/s.scaleY)*s.scaleY;var l=(this.startPos+this.curFrame)%this.numCols,u=Math.floor((this.startPos+this.curFrame-l)/this.numCols),c=l*this.colSize,d=u*this.rowSize,f=this.colSize,p=this.rowSize,g=e-o;if(!(g<0&&(f+=g,e=o,(c-=g)>=this.sheet.width)||(g=i-a)<0&&(p+=g,i=a,(d-=g)>=this.sheet.height)||((g=f+e-o-r)>0&&(f-=g),f<=0||((g=p+i-a-h)>0&&(p-=g),p<=0)))){var m=1,y=1;this.flipX&&(m=-1),this.flipY&&(y=-1),1==m&&1==y||n.scale(m,y),n.drawImage(this.sheet,c,d,f,p,e,i,f,p),1==m&&1==y||n.scale(m,y)}},t.Animation.prototype.drawSliced=function(e,i){var s=t.Stage,n=t.stage,o=s.offset?s.x:0,a=s.offset?s.y:0,r=s.width,h=s.height;this.flipX&&(o=-o-r,e=-e),this.flipY&&(a=-a-h,i=-i),e=Math.round((this.x+e)/s.scaleX)*s.scaleX,i=Math.round((this.y+i)/s.scaleY)*s.scaleY;for(var l=Math.floor((o-e)/this.colSize),u=Math.floor((o+r-e)/this.colSize),c=Math.floor((a-i)/this.rowSize),d=Math.floor((a+h-i)/this.colSize),f=l;f<=u;f++)for(var p=c;p<=d;p++)if(this.sheets[f]&&this.sheets[f][p]){var g=this.sheets[f][p],m=0,y=0,v=g.width,w=g.height,x=(e=this.x+f*this.colSize,i=this.y+p*this.rowSize,e-o);if(x<0&&(v+=x,e=o,(m-=x)>=this.colSize))continue;if((x=i-a)<0&&(w+=x,i=a,(y-=x)>=this.rowSize))continue;if((x=v+e-o-r)>0&&(v-=x),v<=0)continue;if((x=w+i-a-h)>0&&(w-=x),w<=0)continue;var b=1,S=1;this.flipX&&(b=-1),this.flipY&&(S=-1),1==b&&1==S||n.scale(b,S),n.drawImage(g,m,y,v,w,e,i,v,w),1==b&&1==S||n.scale(b,S)}},t.Animation.prototype.reset=function(){this.curFrame=0,this.curInterval=0,this.curLoop=0},t.Animation.prototype.hasPlayed=function(){return this.curLoop==this.loopNum&&this.curFrame==this.length-1},t.Animation.prototype.setColSize=function(t){this.colSize=t,this.numCols=this.sheet.width/this.colSize,this.reset()},t.Animation.prototype.setRowSize=function(t){this.rowSize=t,this.numRows=this.sheet.height/this.rowSize,this.reset()},t.Animation.prototype.setSheet=function(t){this.sheet=t,this.numRows=this.sheet.height/this.rowSize,this.numCols=this.sheet.width/this.colSize,this.reset()},t.Animation.prototype.isVisuallyUnder=function(t,e){return t>=this.x&&t<=this.x+this.colSize&&e>=this.y&&e<=this.y+this.rowSize},t.Animation.prototype.clone=function(e,i){return new t.Animation(this.name,this.sheet,(e||0)+this.x,(i||0)+this.y,this.colSize,this.rowSize,this.startPos,this.length,this.frameInterval,this.loopNum,this.followUp,this.flipX,this.flipY,this.sliced,this.numCols,this.numRows)},t.Animation.prototype.serialize=function(e){var i="",s=!0;if(this.frameIntervals)for(var n in this.frameIntervals)this.frameIntervals.hasOwnProperty(n)&&(i=i+(s?"":",")+n+":"+this.frameIntervals[n],s=!1);else 1!==this.frameInterval&&(i=this.frameInterval);return e=e.concat("\n<animation sheet='"+(this.sheet.name?this.sheet.name:this.sheet)+"' "+("image"!=this.name?"name='"+this.name+"' ":"")+t.serializeAttributes(this,"x","y")+(this.rowSize!=this.sheet.height?"rowSize='"+this.rowSize+"' ":"")+(this.colSize!=this.sheet.width?"colSize='"+this.colSize+"' ":"")+t.serializeAttribute(this,"startPos")+(1!=this.length?"length='"+this.length+"' ":"")+(""!==i?"frameInterval='"+i+"' ":"")+(-1!=this.loopNum?"loopNum='"+this.loopNum+"' ":"")+t.serializeAttributes(this,"folowUp","flipX","flipY")+(this.sliced?"sliced='true' numCols='"+this.numCols+"' numRows='"+this.numRows+"' ":"")+" />")},t.parseAnimation=function(e,i){var s,n,o,a=e.attributes,r="image",h=null,l=0,u=0,c=1,d=1,f=!1,p=0,g=1,m=1,y=-1,v=null;f=(o=a.getNamedItem("sliced"))?"false"!=o.value:f,r=(o=a.getNamedItem("name"))?o.value:r,h=f?(o=a.getNamedItem("sheet"))?o.value:h:(o=a.getNamedItem("sheet"))?i[o.value]:h,l=(o=a.getNamedItem("x"))?parseInt(o.value):l,u=(o=a.getNamedItem("y"))?parseInt(o.value):u,g=(o=a.getNamedItem("length"))?parseInt(o.value):g,c=(o=a.getNamedItem("numCols"))?parseInt(o.value):c,d=(o=a.getNamedItem("numRows"))?parseInt(o.value):d,s=(o=a.getNamedItem("colSize"))?parseInt(o.value):Math.round(h.width/g),n=(o=a.getNamedItem("rowSize"))?parseInt(o.value):h.height,p=(o=a.getNamedItem("startPos"))?parseInt(o.value):p,m=(o=a.getNamedItem("frameInterval"))?o.value:m,y=(o=a.getNamedItem("loopNum"))?parseInt(o.value):y,v=(o=a.getNamedItem("followUp"))?o.value:v;var w=!!(o=a.getNamedItem("flipX"))&&"false"!=o.value,x=!!(o=a.getNamedItem("flipY"))&&"false"!=o.value;return new t.Animation(r,h,l,u,s,n,p,g,m,y,v,w,x,f,c,d)},t}((Sburb=function(t){return t.SpriteButton=function(e,i,s,n,o,a,r){t.Sprite.call(this,e,i,s,n,o),this.pressed=!1,this.mousePressed=!1,this.clicked=!1,this.action;for(var h=0;h<a.width/this.width*(a.height/this.height);h++)this.addAnimation(new t.Animation("state"+h,a,0,0,n,o,h,1,1e3));this.startAnimation("state0")},t.SpriteButton.prototype=new t.Sprite,t.SpriteButton.prototype.update=function(){t.Sprite.prototype.update.call(this),this.updateMouse()},t.SpriteButton.prototype.updateMouse=function(){var e=t.Mouse.x,i=t.Mouse.y,s=t.Mouse.down;if(this.clicked=!1,this.hitsPoint(e-this.width/2,i-this.height/2)&&(t.Stage.style.cursor="pointer"),s)this.mousePressed||(this.mousePressed=!0,this.hitsPoint(e-this.width/2,i-this.height/2)&&(this.pressed=!0));else{if(this.pressed&&this.hitsPoint(e-this.width/2,i-this.height/2)){this.clicked=!0;var n="state"+(parseInt(this.animation.name.substring(5,this.animation.name.length))+1);this.animations[n]?this.startAnimation(n):this.startAnimation("state0")}this.pressed=!1,this.mousePressed=!1}this.clicked&&this.action&&t.performAction(this.action)},t.SpriteButton.prototype.setState=function(t){this.startAnimation("state"+t)},t.SpriteButton.prototype.serialize=function(t){return t=t.concat("\n<spritebutton name='"+this.name+(this.x?"' x='"+this.x:"")+(this.y?"' y='"+this.y:"")+"' width='"+this.width+"' height='"+this.height+"' sheet='"+this.animation.sheet.name+"' >"),this.action&&(t=this.action.serialize(t)),t=t.concat("</spritebutton>")},t.parseSpriteButton=function(e){var i=e.attributes,s=t.assets[i.getNamedItem("sheet").value],n=new t.SpriteButton(i.getNamedItem("name").value,i.getNamedItem("x")?parseInt(i.getNamedItem("x").value):0,i.getNamedItem("y")?parseInt(i.getNamedItem("y").value):0,i.getNamedItem("width")?parseInt(i.getNamedItem("width").value):s.width,i.getNamedItem("width")?parseInt(i.getNamedItem("height").value):s.height,s),o=e.getElementsByTagName("action");if(o.length>0){var a=t.parseAction(o[0]);n.action=a}return n},t}((Sburb=function(t){return t.Character=function(e,i,s,n,o,a,r,h,l,u,c){t.Sprite.call(this,e,i,s,n,o,null,null,t.Sprite.prototype.MG_DEPTHING,!0),this.speed=12,this.vx=0,this.vy=0,this.facing="Front",this.npc=!0,this.spriteType="character",this.following=null,this.followBuffer=null,this.follower=null,this.lastLeaderPos=null,this.handledInput=-1,this.oldX=0,this.oldY=0,c?this.bootstrap=!0:(h="number"==typeof h?h:n,l="number"==typeof l?l:o,this.addAnimation(new t.Animation("idleFront",u,a,r,h,l,0,1,2)),this.addAnimation(new t.Animation("idleRight",u,a,r,h,l,1,1,2)),this.addAnimation(new t.Animation("idleBack",u,a,r,h,l,2,1,2)),this.addAnimation(new t.Animation("idleLeft",u,a,r,h,l,3,1,2)),this.addAnimation(new t.Animation("walkFront",u,a,r,h,l,4,2,4)),this.addAnimation(new t.Animation("walkRight",u,a,r,h,l,6,2,4)),this.addAnimation(new t.Animation("walkBack",u,a,r,h,l,8,2,4)),this.addAnimation(new t.Animation("walkLeft",u,a,r,h,l,10,2,4)),this.startAnimation("walkFront")),this.becomeNPC()},t.Character.prototype=new t.Sprite,t.Character.prototype.followBufferLength=6,t.Character.prototype.update=function(e){this.handleFollowing(e),this.handleInput>0&&(--this.handleInput,0==this.handleInput&&moveNone()),this.tryToMove(this.vx,this.vy,e),t.Sprite.prototype.update.call(this,e)},t.Character.prototype.handleFollowing=function(e){if(this.following){this.following.isNPC()&&!this.isNPC()?(this.becomeNPC(),this.collidable=!0,this.walk()):!this.following.isNPC()&&this.isNPC()&&(this.becomePlayer(),this.collidable=!1),this.following.x==this.lastLeaderPos.x&&this.following.y==this.lastLeaderPos.y||(this.followBuffer.push({x:this.following.x,y:this.following.y}),this.lastLeaderPos.x=this.following.x,this.lastLeaderPos.y=this.following.y);for(var i=null;this.followBuffer.length>this.followBufferLength;){i=this.followBuffer[0];var s,n=e.getInverseMoveFunction(this),o=[];if(s=n?n(i.x-this.x,i.y-this.y):{x:i.x-this.x,y:i.y-this.y},Math.abs(s.x)>=this.speed/1.9&&(s.x>0?o.push(t.Keys.right):o.push(t.Keys.left)),Math.abs(s.y)>=this.speed/1.9&&(s.y>0?o.push(t.Keys.down):o.push(t.Keys.up)),0!=o.length){for(var a={},r=0;r<o.length;r++)a[o[r]]=!0;this.handleInputs(a,o);break}this.followBuffer.splice(0,1)}this.followBuffer.length<=this.followBufferLength&&!this.following.isNPC()&&(i&&(this.x=i.x,this.y=i.y),this.moveNone())}},t.Character.prototype.moveUp=function(t){t?(this.vx*=2/3,this.vy=2*-this.speed/3):(this.facing="Back",this.walk(),this.vx=0,this.vy=-this.speed)},t.Character.prototype.moveDown=function(t){t?(this.vx*=2/3,this.vy=2*this.speed/3):(this.facing="Front",this.walk(),this.vx=0,this.vy=this.speed)},t.Character.prototype.moveLeft=function(){this.facing="Left",this.walk(),this.vx=-this.speed,this.vy=0},t.Character.prototype.moveRight=function(){this.facing="Right",this.walk(),this.vx=this.speed,this.vy=0},t.Character.prototype.moveNone=function(){4==this.animations.walkFront.frameInterval&&(this.idle(),this.vx=0,this.vy=0)},t.Character.prototype.walk=function(){this.startAnimation("walk"+this.facing)},t.Character.prototype.idle=function(){this.startAnimation("idle"+this.facing)},t.Character.prototype.becomeNPC=function(){this.animations.walkFront.frameInterval=12,this.animations.walkBack.frameInterval=12,this.animations.walkLeft.frameInterval=12,this.animations.walkRight.frameInterval=12},t.Character.prototype.becomePlayer=function(){this.animations.walkFront.frameInterval=4,this.animations.walkBack.frameInterval=4,this.animations.walkLeft.frameInterval=4,this.animations.walkRight.frameInterval=4},t.Character.prototype.handleInputs=function(e,i){var s,n,o,a;s=Math.max(i.indexOf(t.Keys.down),i.indexOf(t.Keys.s)),n=Math.max(i.indexOf(t.Keys.up),i.indexOf(t.Keys.w)),o=Math.max(i.indexOf(t.Keys.left),i.indexOf(t.Keys.a)),a=Math.max(i.indexOf(t.Keys.right),i.indexOf(t.Keys.d));var r=!0;o==(h=Math.max(o,a,-.5))?this.moveLeft():a==h?this.moveRight():r=!1;var h,l=!0;s==(h=Math.max(n,s,-.5))?this.moveDown(r):n==h?this.moveUp(r):l=!1,r||l||this.moveNone(),this.handledInput=2},t.Character.prototype.tryToMove=function(e,i,s){var n=s.getMoveFunction(this);n&&(l=n(e,i),e==l.x&&i==l.y||!0,e=l.x,i=l.y),0==e&&0==i||(this.oldX=this.x,this.oldY=this.y);for(var o=t.Stage.scaleX,a=t.Stage.scaleY;Math.abs(e)>=o||Math.abs(i)>=a;){var r=0,h=0;if(Math.abs(e)>=o&&(r=Math.round(o*e/Math.abs(e)),this.x+=r,e-=r),Math.abs(i)>=a&&(h=Math.round(a*i/Math.abs(i)),this.y+=h,i-=h),!this.following){var u;if(u=s.collides(this)){var c=!1;if(0!=r&&(this.collides(u,0,a)?this.collides(u,0,-a)||(h-=a,this.y-=a,c=!0):(h+=a,this.y+=a,c=!0)),c||0==h||(this.collides(u,o,0)?this.collides(u,-o,0)||(r-=o,this.x-=o,c=!0):(r+=o,this.x+=o,c=!0)),!c||s.collides(this))return this.x-=r,this.y-=h,!1}if(!s.isInBounds(this)){c=!1;if(0!=r&&(s.isInBounds(this,0,a)?(h+=a,this.y+=a,c=!0):s.isInBounds(this,0,-a)&&(h-=a,this.y-=a,c=!0)),c||0==h||(s.isInBounds(this,o,0)?(r+=o,this.x+=o,c=!0):s.isInBounds(this,-o,0)&&(r-=o,this.x-=o,c=!0)),!c||s.collides(this))return this.x-=r,this.y-=h,!1}}}return!0},t.Character.prototype.follow=function(t){for(;null!=t.follower;)t=t.follower;this.following=t,t.follower=this,this.followBuffer=[],this.lastLeaderPos={},this.collidable=!1},t.Character.prototype.unfollow=function(){this.following&&(this.following.follower=this.follower,this.follower&&(this.follower.following=this.following,this.follower.followBuffer=[]),this.following=null,this.follower=null,this.lastLeaderPos=null,this.collidable=!0,this.becomeNPC())},t.Character.prototype.getActionQueries=function(){var t=[];return t.push({x:this.x,y:this.y}),"Front"==this.facing?(t.push({x:this.x,y:this.y+(this.height/2+15)}),t.push({x:this.x-this.width/2,y:this.y+(this.height/2+15)}),t.push({x:this.x+this.width/2,y:this.y+(this.height/2+15)})):"Back"==this.facing?(t.push({x:this.x,y:this.y-(this.height/2+15)}),t.push({x:this.x-this.width/2,y:this.y-(this.height/2+15)}),t.push({x:this.x+this.width/2,y:this.y-(this.height/2+15)})):"Right"==this.facing?(t.push({x:this.x+(this.width/2+15),y:this.y}),t.push({x:this.x+(this.width/2+15),y:this.y+this.height/2}),t.push({x:this.x+(this.width/2+15),y:this.y-this.height/2})):"Left"==this.facing&&(t.push({x:this.x-(this.width/2+15),y:this.y}),t.push({x:this.x-(this.width/2+15),y:this.y+this.height/2}),t.push({x:this.x-(this.width/2+15),y:this.y-this.height/2})),t},t.Character.prototype.serialize=function(t){for(var e in t=t.concat("\n<character name='"+this.name+"' x='"+this.x+"' y='"+this.y+"' width='"+this.width+"' height='"+this.height+"' state='"+this.state+"' facing='"+this.facing),t=this.bootstrap?t.concat("' bootstrap='true"):t.concat("' sx='"+this.animations.walkFront.x+"' sy='"+this.animations.walkFront.y+"' sWidth='"+this.animations.walkFront.colSize+"' sHeight='"+this.animations.walkFront.rowSize+"' sheet='"+this.animations.walkFront.sheet.name),this.following&&(t=t.concat("' following='"+this.following.name)),this.follower&&(t=t.concat("' follower='"+this.follower.name)),t=t.concat("'>"),this.animations)if(this.animations.hasOwnProperty(e)){var i=this.animations[e];(this.bootstrap||-1==i.name.indexOf("idle")&&-1==i.name.indexOf("walk"))&&(t=i.serialize(t))}for(var s=0;s<this.actions.length;s++)t=this.actions[s].serialize(t);return t=t.concat("\n</character>")},t.Character.prototype.isNPC=function(){return 12==this.animations.walkFront.frameInterval},t.parseCharacter=function(e,i){var s,n=e.attributes,o=new t.Character(n.getNamedItem("name").value,n.getNamedItem("x")?parseInt(n.getNamedItem("x").value):0,n.getNamedItem("y")?parseInt(n.getNamedItem("y").value):0,parseInt(n.getNamedItem("width").value),parseInt(n.getNamedItem("height").value),n.getNamedItem("sx")?parseInt(n.getNamedItem("sx").value):0,n.getNamedItem("sy")?parseInt(n.getNamedItem("sy").value):0,parseInt(n.getNamedItem("sWidth").value),parseInt(n.getNamedItem("sHeight").value),i[n.getNamedItem("sheet").value]);if(s=n.getNamedItem("following")){var a=t.sprites[s.value];a&&o.follow(a)}if(s=n.getNamedItem("follower")){var r=t.sprites[s.value];r&&r.follow(o)}for(var h=e.getElementsByTagName("animation"),l=0;l<h.length;l++){var u=t.parseAnimation(h[l],i);o.addAnimation(u)}return o.startAnimation(n.getNamedItem("state").value),o.facing=n.getNamedItem("facing").value,o},t}((Sburb=function(t){function e(t,e,i,s,n,o,a,r,h){this.x=e,this.y=i,this.dx="number"==typeof o?o:0,this.dy="number"==typeof a?a:0,this.width=s,this.height=n,this.depthing="number"==typeof r?r:this.BG_DEPTHING,this.collidable="boolean"==typeof h&&h,this.animations={},this.animation=null,this.state=null,this.lastTime=0,this.actions=[],this.name=t,this.queries=null}return e.prototype.BG_DEPTHING=0,e.prototype.MG_DEPTHING=1,e.prototype.FG_DEPTHING=2,e.prototype.addAnimation=function(t){this.animations[t.name]=t},e.prototype.startAnimation=function(t){this.state!=t&&this.animations[t]&&(this.animation=this.animations[t],this.animation.reset(),this.state=t)},e.prototype.update=function(t){this.animation&&(this.animation.hasPlayed()&&this.animation.followUp?this.startAnimation(this.animation.followUp):this.animation.update())},e.prototype.draw=function(){this.animation&&this.animation.draw(this.x,this.y)},e.prototype.isBehind=function(t){return this.depthing==t.depthing?this.y+this.dy<t.y+t.dy:this.depthing<t.depthing},e.prototype.collides=function(t,e,i){var s=this.x+(e||0),n=this.y+(i||0);return!!(t.collidable&&s-this.width/2<t.x+t.width/2&&s+this.width/2>t.x-t.width/2&&n-this.height/2<t.y+t.height/2&&n+this.height/2>t.y-t.height/2)},e.prototype.hitsPoint=function(t,e){return this.x-this.width/2<=t&&this.x+this.width/2>=t&&this.y-this.height/2<=e&&this.y+this.height/2>=e},e.prototype.isVisuallyUnder=function(t,e){return this.animation&&this.animation.isVisuallyUnder(t-this.x,e-this.y)},e.prototype.addAction=function(t){this.actions.push(t)},e.prototype.removeAction=function(t){for(var e=0;e<this.actions.length;e++)if(this.actions[e].name==t)return void this.actions.splice(e,1)},e.prototype.getActions=function(t){for(var e=[],i=0;i<this.actions.length;i++){var s=this.actions[i],n=s.sprite;(!n||n==t.name||"!"==n.charAt(0)&&n.substring(1)!=t.name)&&e.push(s)}return e},e.prototype.getBoundaryQueries=function(t,e){var i=this.x+(t||0),s=this.y+(e||0),n=this.width/2,o=this.height/2;return this.queries||(this.queries={upRight:{},upLeft:{},downLeft:{},downRight:{},downMid:{},upMid:{}}),this.queries.upRight.x=i+n,this.queries.upRight.y=s-o,this.queries.upLeft.x=i-n,this.queries.upLeft.y=s-o,this.queries.downLeft.x=i-n,this.queries.downLeft.y=s+o,this.queries.downRight.x=i+n,this.queries.downRight.y=s+o,this.queries.downMid.x=i,this.queries.downMid.y=s+o,this.queries.upMid.x=i,this.queries.upMid.y=s-o,this.queries},e.prototype.serialize=function(e){var i=0;for(var s in this.animations)this.animations.hasOwnProperty(s)&&i++;for(var s in e=e.concat("\n<sprite "+t.serializeAttributes(this,"name","x","y","dx","dy","width","height","depthing","collidable")+(i>1?"state='"+this.state+"' ":"")+">"),this.animations)this.animations.hasOwnProperty(s)&&(e=this.animations[s].serialize(e));for(var n=0;n<this.actions.length;n++)e=this.actions[n].serialize(e);return e=e.concat("\n</sprite>")},e.prototype.clone=function(e){var i=new t.Sprite(e,this.x,this.y,this.width,this.height,this.dx,this.dy,this.depthing,this.collidable);for(var s in this.animations)this.animations.hasOwnProperty(s)&&i.addAnimation(this.animations[s].clone());for(var n in this.actions)this.actions.hasOwnProperty(n)&&i.addAction(this.actions[n].clone());return this.animation&&i.startAnimation(this.animation.name),t.sprites[e]=i,i},t.parseSprite=function(i,s){var n,o=i.attributes,a=null,r=0,h=0,l=0,u=0,c=0,d=0,f=0,p=!1,g=null;a=(n=o.getNamedItem("name"))?n.value:a,r=(n=o.getNamedItem("x"))?parseInt(n.value):r,h=(n=o.getNamedItem("y"))?parseInt(n.value):h,l=(n=o.getNamedItem("width"))?parseInt(n.value):l,u=(n=o.getNamedItem("height"))?parseInt(n.value):u,c=(n=o.getNamedItem("dx"))?parseInt(n.value):c,d=(n=o.getNamedItem("dy"))?parseInt(n.value):d,f=(n=o.getNamedItem("depthing"))?parseInt(n.value):f,p=(n=o.getNamedItem("collidable"))?"false"!=n.value:p,g=(n=o.getNamedItem("state"))?n.value:g;for(var m=new e(a,r,h,l,u,c,d,f,p),y=i.getElementsByTagName("animation"),v=0;v<y.length;v++){var w=t.parseAnimation(y[v],s);m.addAnimation(w),null==g&&(g=w.name)}if(0==y.length){var x=t.assets[a];x&&"graphic"==x.type&&(m.addAnimation(new t.Animation("image",x)),g="image")}return m.startAnimation(g),m},t.Sprite=e,t}((Sburb=function(t){t.Keys={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,escape:27,space:32,left:37,up:38,right:39,down:40,w:87,a:65,s:83,d:68,tilde:192},t.name="Jterniabound",t.version="1.0",t.Container=null,t.Game=null,t.Map=null,t.Stage=null,t.Bins={},t.cam={x:0,y:0},t.crashed=!1,t.stage=null,t.gameState={},t.pressed=null,t.pressedOrder=null,t.debugger=null,t.assetManager=null,t.assets=null,t.sprites=null,t.effects=null,t.buttons=null,t.rooms=null,t.char=null,t.curRoom=null,t.destRoom=null,t.destX=null,t.destY=null,t.focus=null,t.destFocus=null,t.chooser=null,t.inputDisabled=!1,t.curAction=null,t.actionQueues=[],t.nextQueueId=0,t.bgm=null,t.hud=null,t.Mouse={down:!1,x:0,y:0},t.waitFor=null,t.engineMode="wander",t.fading=!1,t.lastMusicTime=-1,t.musicStoppedFor=0,t.loadingRoom=!1,t.tests=null,t.prefixed=null,t.firedAsync=!1,t.updateLoop=null,t.initFinished=null,t._hardcode_load=null,t._include_dev=!1;function e(){t.updateLoop&&(clearInterval(t.updateLoop),clearInterval(t.drawLoop),t.updateLoop=t.drawLoop=null),t.assetManager.start()}function i(){t.bgm&&t.bgm.asset&&((t.bgm.asset.ended||t.bgm.asset.currentTime>=t.bgm.asset.duration)&&t.bgm.loop(),t.lastMusicTime==t.bgm.asset.currentTime?(t.musicStoppedFor++,t.musicStoppedFor>4&&(t.bgm.asset.pause(),t.bgm.asset.play())):t.musicStoppedFor=0,t.bgm.asset.paused&&t.bgm.play(),t.lastMusicTime=t.bgm.asset.currentTime),function(){t.Stage&&(t.Stage.style.cursor="default");r()&&!t.inputDisabled?t.char.handleInputs(t.pressed,t.pressedOrder):t.char.moveNone();t.debugger.handleInputs(t.pressed)}(),function(){for(var e in t.hud)if(t.hud.hasOwnProperty(e)){var i=t.hud[e];i.update()}}(),t.loadingRoom||t.curRoom.update(),function(){t.destFocus?Math.abs(t.destFocus.x-t.cam.x-t.Stage.width/2)>4||Math.abs(t.destFocus.y-t.cam.y-t.Stage.height/2)>4?(t.cam.x+=(t.destFocus.x-t.Stage.width/2-t.cam.x)/5,t.cam.y+=(t.destFocus.y-t.Stage.height/2-t.cam.y)/5):(t.focus=t.destFocus,t.destFocus=null):t.focus&&(t.cam.x=t.focus.x-t.Stage.width/2,t.cam.y=t.focus.y-t.Stage.height/2);t.Stage.x=Math.max(0,Math.min(Math.round(t.cam.x/t.Stage.scaleX)*t.Stage.scaleX,t.curRoom.width-t.Stage.width)),t.Stage.y=Math.max(0,Math.min(Math.round(t.cam.y/t.Stage.scaleX)*t.Stage.scaleX,t.curRoom.height-t.Stage.height))}(),function(){if(t.destRoom||t.fading)if(t.Stage.fade<1.1)t.Stage.fade=Math.min(1.1,t.Stage.fade+t.Stage.fadeRate);else if(t.destRoom){for(var e=t.destX-t.char.x,i=t.destY-t.char.y,s=t.char;s;)s.x+=e,s.y+=i,s.followBuffer=[],s=s.follower;t.moveSprite(t.char,t.curRoom,t.destRoom),t.curRoom.exit(),t.curRoom=t.destRoom,t.curRoom.enter(),t.destRoom=null}else t.fading=!1;else r()&&t.Stage.fade>.01&&(t.Stage.fade=Math.max(.01,t.Stage.fade-t.Stage.fadeRate))}(),t.chooser.update(),t.dialoger.update(),function(){t.curAction&&l(t);for(var e=0;e<t.actionQueues.length;e++){var i=t.actionQueues[e];if(i.curAction){if(i.paused||i.waitFor){if(!(i.trigger&&i.trigger.checkCompletion()||i.waitFor))continue;i.paused=!1,i.trigger=null}l(i)}else t.actionQueues.remove(e),e--}}(),function(){t.waitFor&&t.waitFor.checkCompletion()&&(t.waitFor=null);t.inputDisabled&&t.inputDisabled.checkCompletion&&t.inputDisabled.checkCompletion()&&(t.inputDisabled=!1)}()}function s(){t.playingMovie||(t.stage.save(),t.Stage.offset=!0,t.stage.translate(-t.Stage.x,-t.Stage.y),t.curRoom.draw(),t.stage.restore(),t.Stage.offset=!1,t.Stage.fade>.1&&(t.stage.fillStyle="rgba(0,0,0,"+t.Stage.fade+")",t.stage.fillRect(0,0,t.Stage.width,t.Stage.height)),t.dialoger.draw(),function(){for(var e in t.hud)t.hud.hasOwnProperty(e)&&t.hud[e].draw()}(),t.stage.save(),t.Stage.offset=!0,t.stage.translate(-t.Stage.x,-t.Stage.y),t.chooser.draw(),t.stage.restore(),t.Stage.offset=!1,t.debugger.draw())}t.testCompatibility=function(e,i,s){if(Modernizr.xhr2&&!t.firedAsync){try{var n=new XMLHttpRequest;n.open("GET",i,!0),n.responseType="blob",n.onload=function(){200!=this.status&&0!=this.status||!this.response?Modernizr.addTest("xhrblob",function(){return!1}):Modernizr.addTest("xhrblob",function(){return!0})},n.onabort=function(){Modernizr.addTest("xhrblob",function(){return!1})},n.onerror=function(){Modernizr.addTest("xhrblob",function(){return!1})},n.send(),(n=new XMLHttpRequest).open("GET",i,!0),n.responseType="arraybuffer",n.onload=function(){if(200!=this.status&&0!=this.status||!this.response)Modernizr.addTest("xhrarraybuffer",function(){return!1});else{this.response;Modernizr.addTest("xhrarraybuffer",function(){return!0})}},n.onabort=function(){Modernizr.addTest("xhrarraybuffer",function(){return!1})},n.onerror=function(){Modernizr.addTest("xhrarraybuffer",function(){return!1})},n.send()}catch(t){alert(t.message+"\n\nIf you are running Google Chrome, you need to run it with the -allow-file-access-from-files switch to load this.")}t.firedAsync=!0}else Modernizr.addTest("xhrblob",function(){return!1}),Modernizr.addTest("xhrarraybuffer",function(){return!1});if(!("xhrblob"in Modernizr&&"xhrarraybuffer"in Modernizr&&"datauri"in Modernizr))return setTimeout(function(){t.initialize(e,i,s)},200),void(t.crashed=!0);var o=[];if(Modernizr.fontface||o.push("- Lack of CSS @font-face support."),Modernizr.canvas||o.push("- Lack of canvas support."),Modernizr.canvastext||o.push("- Lack of canvas text support."),Modernizr.json||o.push("- Lack of JSON support."),Modernizr.xmlserializer||o.push("- Lack of XMLSerializer support."),o.length){var a='<div style="padding-left: 0; padding-right: 0; margin-left: auto; margin-right: auto; display: block; width:650px; height:450px; overflow: auto;">';a+='<p style="font-weight: bold;">Your browser is too old. Here are the problems we found:</p>';for(var r=0;r<o.length;r++)a+="<p>"+o[r]+"</p>";a+="<p>Maybe try Chrome instead?</p>",a+="</div>",document.getElementById(e).innerHTML=a,t.crashed=!0}else t.prefixed=Modernizr.prefixed,t.tests={},t.tests.blobrevoke=Modernizr.blob&&Modernizr.blob.revoke,Modernizr.audio&&(Modernizr.audio.mp3||Modernizr.audio.ogg)?(t.tests.audio=new Boolean(!0),t.tests.audio.mp3=Modernizr.audio.mp3,t.tests.audio.ogg=Modernizr.audio.ogg):t.tests.audio=!1,Modernizr.localstorage||Modernizr.sessionstorage?(t.tests.storage=new Boolean(!0),t.tests.storage.local=Modernizr.localstorage,t.tests.storage.session=Modernizr.sessionstorage):t.tests.storage=!1,t.tests.loading=0,Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=11:Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder?t.tests.loading=10:Modernizr.xhrblob&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.slice?t.tests.loading=9:Modernizr.xhrblob&&Modernizr.datauri&&Modernizr.filereader?t.tests.loading=8:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=7:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator?t.tests.loading=6:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder?t.tests.loading=5:Modernizr.xhrarraybuffer&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview&&Modernizr.datauri?t.tests.loading=4:Modernizr.overridemimetype&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.creator&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview?t.tests.loading=3:Modernizr.overridemimetype&&Modernizr.blob&&Modernizr.blob.url&&Modernizr.blob.builder&&Modernizr.arraybuffer&&Modernizr.arraybuffer.dataview?t.tests.loading=2:Modernizr.overridemimetype&&Modernizr.datauri?t.tests.loading=1:Modernizr.vbarray&&Modernizr.datauri&&(t.tests.loading=12)},t.initialize=function(e,i,s){if(t.crashed=!1,t.testCompatibility(e,i,s),!t.crashed){t.debugger=new t.Debugger;var r=document.createElement("div");r.style.position="relative",r.style.padding="0",r.style.margin="auto";var h=document.createElement("div");h.id="SBURBgameDiv",h.onkeydown=n,h.onkeyup=o,h.style.position="absolute",h.style.zIndex="100",r.appendChild(h);var l=document.createElement("div");l.id="SBURBmovieBin",l.style.position="absolute",l.style.zIndex="200",r.appendChild(l);var u=document.createElement("div");u.id="SBURBfontBin",r.appendChild(u);var c=document.createElement("div");c.id="SBURBgifBin",c.style.width="0",c.style.height="0",c.style.overflow="hidden",r.appendChild(c);var d=document.createElement("canvas");d.id="SBURBStage",d.onmousedown=function(e){t.onMouseDown(e,this)},d.onmouseup=function(e){t.onMouseUp(e,this)},d.onmousemove=function(e){t.onMouseMove(e,this)},d.tabIndex=0,d.scaleX=d.scaleY=3,d.x=d.y=0,d.fps=30,d.fade=0,d.fadeRate=.1,d.innerText="ERROR: Your browser is too old to display this content!",h.appendChild(d);var f=document.createElement("canvas");f.id="SBURBMapCanvas",f.width=1,f.height=1,f.style.display="none",h.appendChild(f),document.getElementById(e).appendChild(r),t.Container=r,t.Game=h,t.Map=f,t.Stage=d,t.Bins.movie=l,t.Bins.font=u,t.Bins.gif=c,t.setDimensions(650,450),t.stage=t.Stage.getContext("2d"),t.Stage.onblur=a,t.chooser=new t.Chooser,t.dialoger=null,t.assetManager=new t.AssetManager,t.assets=t.assetManager.assets,t.rooms={},t.sprites={},t.effects={},t.buttons={},t.hud={},t.gameState={},t.pressed={},t.pressedOrder=[],t.loadSerialFromXML(i)}},t.setDimensions=function(e,i){e&&(t.Container.style.width=e+"px",t.Stage.width=e),i&&(t.Container.style.height=i+"px",t.Stage.height=i)};var n=function(e){if(t.updateLoop&&!t.inputDisabled)if(t.chooser.choosing)e.keyCode!=t.Keys.down&&e.keyCode!=t.Keys.s||t.chooser.nextChoice(),e.keyCode!=t.Keys.up&&e.keyCode!=t.Keys.w||t.chooser.prevChoice(),e.keyCode!=t.Keys.space||t.pressed[t.Keys.space]||(t.performAction(t.chooser.choices[t.chooser.choice]),t.chooser.choosing=!1);else if(t.dialoger.talking)e.keyCode!=t.Keys.space||t.pressed[t.Keys.space]||t.dialoger.nudge();else if(r()&&e.keyCode==t.Keys.space&&!t.pressed[t.Keys.space]&&"wander"==t.engineMode){t.chooser.choices=[];for(var i=t.char.getActionQueries(),s=0;s<i.length&&(t.chooser.choices=t.curRoom.queryActions(t.char,i[s].x,i[s].y),!(t.chooser.choices.length>0));s++);t.chooser.choices.length>0&&(t.chooser.choices.push(new t.Action("cancel","cancel","Cancel.")),h())}return t.pressed[e.keyCode]||t.pressedOrder.push(e.keyCode),t.pressed[e.keyCode]=!0,!!(e.altKey||e.ctrlKey||e.metaKey)},o=function(e){t.pressed[e.keyCode]&&t.pressedOrder.destroy(e.keyCode),t.pressed[e.keyCode]=!1};var a=function(e){t.pressed={},t.pressedOrder=[]};function r(){return!(t.dialoger.talking||t.chooser.choosing||t.destRoom||t.fading||t.destFocus)}function h(){t.char.idle(),t.chooser.beginChoosing(t.char.x,t.char.y)}function l(e){e.curAction.times<=0?e.curAction.followUp?(r()||e.curAction.followUp.noWait||e.noWait)&&t.performAction(e.curAction.followUp,e):e.curAction=null:(r()||e.curAction.noWait||e.noWait)&&t.performAction(e.curAction,e)}function u(e,i){var s=!1;i.curAction=e.clone();do{s&&(i.curAction=i.curAction.followUp.clone()),c(i,t.performActionSilent(i.curAction)),s=!0}while(i.curAction&&i.curAction.times<=0&&i.curAction.followUp&&i.curAction.followUp.noDelay)}function c(t,e){e&&(t.hasOwnProperty("trigger")?(t.paused=!0,t.trigger=e):t.waitFor=e)}return t.onMouseMove=function(e,i){var s=function(t,e){var i=0,s=0,n=0,o=0,a=e;do{i+=a.offsetLeft,s+=a.offsetTop}while(a=a.offsetParent);return n=t.pageX-i,o=t.pageY-s,{x:n,y:o}}(e,i);t.Mouse.x=s.x,t.Mouse.y=s.y},t.onMouseDown=function(e,i){t.updateLoop&&("strife"==t.engineMode&&r()&&(t.chooser.choices=t.curRoom.queryActionsVisual(t.char,t.Stage.x+t.Mouse.x,t.Stage.y+t.Mouse.y),t.chooser.choices.length>0&&(t.chooser.choices.push(new t.Action("cancel","cancel","cancel")),h())),t.Mouse.down=!0)},t.onMouseUp=function(e,i){t.Mouse.down=!1,t.updateLoop&&t.dialoger&&t.dialoger.box&&t.dialoger.box.isVisuallyUnder(t.Mouse.x,t.Mouse.y)&&t.dialoger.nudge()},t.performAction=function(e,i){if(e.silent){if(1==e.times&&!e.followUp)return t.performActionSilent(e),null;if(!i||i==t){if(!0===e.silent)i=new t.ActionQueue(e);else{var s=e.silent.split(":"),n="full"==s[0],o=null;n&&s.shift(),s.length>0&&(o=s.shift()),i=new t.ActionQueue(e,o,s,n)}t.actionQueues.push(i)}}return i&&i!=t?(u(e,i),i):(t.curAction&&t.curAction.followUp!=e&&t.curAction!=e||!r())&&e.soft?null:(u(e,t),null)},t.performActionSilent=function(e){e.times--;var i=e.info();return i&&(i=i.trim()),t.commands[e.command.trim()](i)},t.changeRoom=function(e,i,s){t.destRoom=e,t.destX=i,t.destY=s},t.moveSprite=function(t,e,i){for(var s=t;s;)e.removeSprite(s),i.addSprite(s),s=s.follower},t.setCurRoomOf=function(e){if(!t.curRoom.contains(e))for(var i in t.rooms)if(t.rooms.hasOwnProperty(i)&&t.rooms[i].contains(e))return void t.changeRoom(t.rooms[i],t.char.x,t.char.y)},t.changeBGM=function(e){if(e){if(t.bgm){if(t.bgm.asset==e.asset&&t.bgm.startLoop==e.startLoop)return;t.bgm.stop()}t.bgm=e,t.bgm.stop(),t.bgm.play()}},t.playEffect=function(e,i,s){t.curRoom.addEffect(e.clone(i,s))},t.playSound=function(t){t.stop(),t.play()},t.playMovie=function(e){var i=e.name;document.getElementById(i).style.display="block",t.waitFor=new t.Trigger("movie,"+i+",5"),t.playingMovie=!0},t.startUpdateProcess=function(){e(),t.assetManager.stop(),t.updateLoop=setInterval(i,1e3/t.Stage.fps),t.drawLoop=setInterval(s,1e3/t.Stage.fps)},t.haltUpdateProcess=e,t.draw=s,t}(Sburb||{}))||{}))||{}))||{}))||{}))||{});!function(){try{new Uint8Array(1);return}catch(t){}function t(t,e){return this.slice(t,e)}function e(t,e){arguments.length<2&&(e=0);for(var i=0,s=t.length;i<s;++i,++e)this[e]=255&t[i]}function i(i){var s;if("number"==typeof i){s=new Array(i);for(var n=0;n<i;++n)s[n]=0}else s=i.slice(0);return s.subarray=t,s.buffer=s,s.byteLength=s.length,s.set=e,"object"==typeof i&&i.buffer&&(s.buffer=i.buffer),s}window.Uint8Array=i,window.Uint32Array=i,window.Int32Array=i}();Sburb=function(t){return t.ActionQueue=function(e,i,s,n,o,a){this.curAction=e,this.id=i&&i.length>0?i:t.nextQueueId++,this.groups=s||[],this.noWait=n||!1,this.paused=!!o,this.trigger=a},t.ActionQueue.prototype.hasGroup=function(t){for(var e=0;e<this.groups.length;e++)if(this.groups[e]==t)return!0;return!1},t.ActionQueue.prototype.serialize=function(e){if(!this.curAction)return"";for(var i="",s=0;s<this.groups.length;s++)i+=(s>0?":":"")+this.groups[s];return e=e.concat("\n<actionQueue "+t.serializeAttributes(this,"id","noWait","paused")+(0==i.length?"":" groups='"+i+"'")+">"),e=this.curAction.serialize(e),this.trigger&&(e=this.trigger.serialize(e)),e=e.concat("</actionQueue>")},t.getActionQueueById=function(t){for(var e=0;e<this.actionQueues.length;e++){var i=this.actionQueues[e];if(i.id==t)return i}},t.removeActionQueueById=function(t){for(var e=0;e<this.actionQueues.length;e++){if(this.actionQueues[e].id==t)return void this.actionQueues.remove(e)}},t.forEachActionQueueInGroup=function(t,e){for(var i=0;i<this.actionQueues.length;i++){var s=this.actionQueues[i];s.hasGroup(t)&&e(s)}},t.removeActionQueuesByGroup=function(t){for(var e=0;e<this.actionQueues.length;e++){this.actionQueues[e].hasGroup(t)&&(this.actionQueues.remove(e),e--)}},t.parseActionQueue=function(e){for(var i,s,n=e.attributes,o=null,a=null,r=!1,h=!1,l=null,u=e.childNodes,c=0;c<u.length;c++)"#text"!=u[c].nodeName&&("action"==u[c].nodeName?o=t.parseAction(u[c]):l=t.parseTrigger(u[c]));return i=(s=n.getNamedItem("id"))?s.value:t.nextQueueId++,a=(s=n.getNamedItem("groups"))?s.value.split(":"):a,r=(s=n.getNamedItem("noWait"))?"true"==s.value:r,h=(s=n.getNamedItem("paused"))?"true"==s.value:h,new t.ActionQueue(o,i,a,r,h,l)},t}((Sburb=function(t){return t.Path=function(){this.points=[]},t.Path.prototype.push=function(t){this.points.push(t)},t.Path.prototype.queryBatchPos=function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=e[i]||this.query(t[i]))},t.Path.prototype.queryBatchNeg=function(t,e){for(var i in t)t.hasOwnProperty(i)&&(e[i]=e[i]&&!this.query(t[i]))},t.Path.prototype.query=function(t){for(var e=!1,i=-1,s=this.points.length,n=s-1;++i<s;n=i){var o=this.points[i],a=this.points[n];(o.y<=t.y&&t.y<a.y||a.y<=t.y&&t.y<o.y)&&t.x<(a.x-o.x)*(t.y-o.y)/(a.y-o.y)+o.x&&(e=!e)}return e},t}((Sburb=function(t){return t.Debugger=function(){this.url="http://sburb.info/report/version1/",this.fps=0,this.errors=[],this.xhrs=[],this.tests={},this.open=!1,this.tilde=!1,this.space=!1,this.getImg=!1,this.img=!1,this.report=!1,this.colors={error:"#CC0000",exception:"#990000",warn:"#CCCC00",info:"#000099",log:"#AAAAAA",debug:"#777777",success:"#00CC00",failure:"#CC0000",variant11:"#00CC00",variant10:"#00CC00",variant9:"#00CC00",variant8:"#00CC00",variant7:"#CCAA00",variant6:"#CCAA00",variant5:"#CCAA00",variant4:"#CCAA00",variant3:"#FF6600",variant2:"#FF6600",variant1:"#FF6600",variant12:"#FF6600",variant0:"#CC0000"},this.tests["Audio Support"]=t.tests.audio?"success":"failure",this.tests["Save Support"]=t.tests.storage?"success":"failure",this.tests["File Loading ["+t.tests.loading+"]"]="variant"+t.tests.loading;var e=this;this.console=new t.Console,this.XMLHttpRequest=window.XMLHttpRequest,window.XMLHttpRequest=function(){return new t.XMLHttpRequest},window.addEventListener("error",function(t){e.errors.push({type:t.type,text:t.message,url:t.filename,line:t.lineno,time:t.timeStamp})},!1)},t.Debugger.prototype.handleInputs=function(e){e[t.Keys.tilde]&&!this.tilde&&(this.tilde=!0,this.open=!this.open),e[t.Keys.space]&&!this.space&&this.open&&(this.space=!0,this.sendDebugReport()),e[t.Keys.tilde]||(this.tilde=!1),e[t.Keys.space]||(this.space=!1),e[t.Keys.escape]&&(this.open=!1)},t.Debugger.prototype.draw=function(){this.fps++;var e=this;if(setTimeout(function(){e.fps--},1e3),this.getImg&&(this.getImg=!1,this.img=t.Stage.toDataURL(),this.gotImg()),this.open){var i=t.stage.lineWidth,s=t.stage.strokeStyle;t.stage.lineWidth=9,t.stage.strokeStyle="#000000",t.stage.beginPath();for(var n=0;n<=t.Stage.height;n+=10)t.stage.moveTo(0,n),t.stage.lineTo(t.Stage.width,n);t.stage.closePath(),t.stage.stroke(),t.stage.lineWidth=i,t.stage.strokeStyle=s,t.stage.textAlign="left",t.stage.font="bold 18px Verdana";for(var o=this.errors.length-1,a=t.Stage.height-15;o>=0;o--,a-=24)this.errors[o].type in this.colors?t.stage.fillStyle=this.colors[this.errors[o].type]:t.stage.fillStyle="#000000",t.stage.fillText(this.errors[o].text,10,a);a=70;for(var r in t.stage.textAlign="right",t.stage.font="bold 18px Verdana",this.tests)if(this.tests.hasOwnProperty(r)){var h=this.tests[r],l=t.stage.measureText(r).width;t.stage.fillStyle=this.colors[h],t.stage.fillRect(t.Stage.width-(l+20),a,l+10,24),t.stage.fillStyle="#FFFFFF",t.stage.fillText(r,t.Stage.width-15,a+18),a+=26}t.stage.fillStyle="#000000",t.stage.fillRect(t.Stage.width/2-125,10,250,65),t.stage.textAlign="center",t.stage.fillStyle="#FFFFFF",t.stage.font="bold 28px Verdana",t.stage.fillText("Sburb Debugger",t.Stage.width/2,33),t.stage.font="14px Verdana",t.stage.fillText("Press SPACE to send bug report",t.Stage.width/2,51),t.stage.fillText("Press ~ or ESC to exit",t.Stage.width/2,67),t.stage.fillStyle="#000000",t.stage.fillRect(t.Stage.width-50,t.Stage.height-25,50,25),t.stage.textAlign="right",t.stage.fillStyle="#FFFFFF",t.stage.font="bold 16px Verdana",t.stage.fillText(this.fps+"fps",t.Stage.width-8,t.Stage.height-10),t.stage.textAlign="center",t.stage.fillStyle="#000000"}},t.Debugger.prototype.sendDebugReport=function(){var e=document.createElement("div"),i=document.createElement("h2"),s=document.createElement("form"),n=document.createElement("textarea"),o=document.createElement("input");e.id="sburb_debug_report",e.style.position="absolute",e.style.zIndex="9999",e.style.background="white",e.style.width="550px",e.style.top="100px",e.style.left="50px",i.innerText="What seems to be the problem?",i.style.margin="0 20px",s.method="POST",s.action="#",s.style.textAlign="right",s.onsubmit=this.submitForm,n.id="sburb_debug_report_box",n.style.width="530px",n.style.height="200px",n.style.margin="0 8px",n.style.display="block",o.type="submit",o.value="Send Bug Report",s.appendChild(n),s.appendChild(o),e.appendChild(i),e.appendChild(s),t.Game.parentNode.appendChild(e),n.focus()},t.Debugger.prototype.submitForm=function(){var e=document.getElementById("sburb_debug_report");return t.debugger.report=document.getElementById("sburb_debug_report_box").value,t.debugger.getImg=!0,e.parentNode.removeChild(e),!1},t.Debugger.prototype.gotImg=function(){var e,i={fps:this.fps,errors:this.errors,tests:this.tests,xhrs:this.xhrs},s={debugger:JSON.stringify(i),canvas:this.img.substr(22),report:this.report,url:location.href,save:t.serialize(t)},n=[];for(k in s)s.hasOwnProperty(k)&&n.push(encodeURIComponent(k)+"="+encodeURIComponent(s[k]));e=n.join("&");var o=new XMLHttpRequest;o.open("POST",this.url,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)console.debug("Bug report failed to send.");else{var t=JSON.parse(this.responseText);"success"in t&&t.success?console.debug("Bug report sent."):console.debug("Bug report failed to save.")}},o.onerror=function(){console.debug("Bug report failed to send.")},o.onabort=function(){console.debug("Bug report failed to send.")},o.send(e)},t.Console=function(){var e=this._console=window.console;window.console=this;var i,s={log:1,debug:1,info:1,warn:1,error:1,exception:1},n=function(e,i){var s=Array.prototype.slice.call(i);t.debugger.errors.push({type:e,text:s.join(", ")})},o=function(t,i){return e[t].apply(e,i)};for(var a in e)if(!(a in s))try{(i=e[a])&&"[object Function]"==={}.toString.call(i)?void 0===this[a]&&(this[a]=function(t,e){return function(){return e(t,arguments)}}(a,o)):this[a]=e[a]}catch(t){}return this.log=function(){return n("log",arguments),o("log",arguments)},this.debug=function(){return n("debug",arguments),o("debug",arguments)},this.info=function(){return n("info",arguments),o("info",arguments)},this.warn=function(){return n("warn",arguments),o("warn",arguments)},this.error=function(){return n("error",arguments),o("error",arguments)},this.exception=function(){return n("exception",arguments),o("exception",arguments)},this},t.XMLHttpRequest=function(){var e=this,i=e._xhr=new t.debugger.XMLHttpRequest;e.reqType=null,e.reqUrl=null,e.reqStart=null,e.readyState=0,e.onreadystatechange=function(){},e.spy={requestHeaders:[],responseHeaders:[],method:null,url:null,async:null,loaded:!1,status:null,statusText:null,data:null};e.xhr&&e.xhr.open&&e.xhr.open.apply;var s=function(t){return t&&"[object Function]"==={}.toString.call(t)},n={abort:1,channel:1,getInterface:1,mozBackgroundRequest:1,multipart:1,onreadystatechange:1,open:1,send:1,setRequestHeader:1},o={channel:1,onreadystatechange:1,readyState:1,responseBody:1,responseText:1,responseXML:1,status:1,statusText:1,upload:1,spy:1,_xhr:1},a=function(){for(var t in i)if(!(t in n))try{i[t]&&!s(i[t])&&(e[t]=i[t])}catch(t){}},r=function(){(new Date).getTime(),e.reqStart;for(var s=200==i.status||0==i.status,n=i.status+" "+i.statusText,o=i.getAllResponseHeaders(),r=o?o.split(/[\n\r]/):[],h=/^(\S+):\s*(.*)/,l=0,u=r.length;l<u;l++){var c=r[l].match(h);if(c){var d=c[1],f=c[2];"Content-Type"==d&&(e.spy.mimeType=f),e.spy.responseHeaders.push({name:d,value:f})}}e.spy.loaded=!0,e.spy.status=i.status,e.spy.statusText=n,a(),t.debugger.xhrs.push(e.spy),s||console.warn("XHR for "+e.spy.url+" failed")},h=function(){e.readyState=i.readyState,4==i.readyState&&(r(),i.onreadystatechange=function(){}),e.onreadystatechange()};for(var l in this.open=function(t,s,n,o,r){a(),e.spy.method=t,e.spy.url=s,e.spy.async=n,n&&(i.onreadystatechange=h),this.supportsApply?i.open.apply(i,arguments):i.open(t,s,n,o,r)},this.send=function(t){e.spy.data=t,e.reqStart=(new Date).getTime(),function(){for(var t in e)if(!(t in o))try{e[t]&&!i[t]&&(i[t]=e[t])}catch(t){}}();try{i.send(t)}catch(t){throw t}finally{e.spy.async||(e.readyState=i.readyState,r())}},this.setRequestHeader=function(t,s){return e.spy.requestHeaders.push({name:t,value:s}),i.setRequestHeader(t,s)},this.abort=function(){i.abort(),a(),handleRequestStatus(!1,"Aborted")},i)if(!(l in n))try{s(i[l])?void 0===e[l]&&(e[l]=function(t,e){return this.supportsApply?function(){return e[t].apply(e,arguments)}:function(i,s,n,o,a){return e[t](i,s,n,o,a)}}(l,i)):e[l]=i[l]}catch(t){}return this},t}((Sburb=function(t){return t.AssetManager=function(){this.loopID=!1,this.space=!1,this.refresh=!1,this.totalAssets=0,this.totalLoaded=0,this.totalMeta=0,this.totalSize=0,this.loadedSize=0,this.assets={},this.loaded={},this.recurrences={},this.error=[],this.failed=[],this.maxAjax=10,this.ajaxRunning=0,this.ajaxCache=[],this.cache={},this.blobs={},this.description="",this.resourcePath="",this.levelPath="",this.mimes={jpg:"image/jpeg",gif:"image/gif",png:"image/png",svg:"image/svg+xml",mp3:"audio/mpeg",oga:"audio/ogg",ogg:"audio/ogg",ttf:"application/x-font-ttf",woff:"application/x-font-woff",swf:"application/x-shockwave-flash",flv:"application/x-shockwave-flash"}},t.AssetManager.prototype.start=function(){this.stop(),this.loopID=setInterval(function(){t.assetManager.loop()},33)},t.AssetManager.prototype.stop=function(){this.loopID&&(clearInterval(this.loopID),this.loopID=!1)},t.AssetManager.prototype.loop=function(){t.pressed[t.Keys.space]&&!this.space?(this.space=!0,this.refresh=!0):this.refresh=!1,t.pressed[t.Keys.space]||(this.space=!1),t.debugger.handleInputs(t.pressed),this.draw(),t.debugger.draw()},t.AssetManager.prototype.resolvePath=function(e){return-1==e.indexOf(this.resourcePath)?this.resourcePath+"/"+e+"?"+t.version:e+"?"+t.version},t.AssetManager.prototype.totalAssetsRemaining=function(){return this.totalAssets-this.totalLoaded},t.AssetManager.prototype.finishedLoading=function(){return this.totalAssets&&this.totalAssets==this.totalLoaded},t.AssetManager.prototype.draw=function(){if(t.stage.fillStyle="rgb(0,0,0)",t.stage.fillRect(-3,-3,t.Stage.width+6,t.Stage.height+6),this.loaded.preloaderBG){var e=t.assets.preloaderBG;t.stage.drawImage(e,0,0,e.width,e.height,0,0,e.width,e.height)}t.stage.fillStyle="rgb(255,255,255)",t.stage.font="10px Verdana",t.stage.textAlign="center";var i=0;if(i=this.totalSize&&this.totalMeta>=this.totalAssets?Math.floor(this.loadedSize/this.totalSize*100):Math.floor(this.totalLoaded/this.totalAssets*100),t.stage.fillText(i+"%",t.Stage.width/2,t.Stage.height-50),0==t.tests.loading&&t.stage.fillText("Warning: File loading is unreliable. Use a newer browser, like Chrome.",t.Stage.width/2,t.Stage.height-35),this.error.length){t.stage.textAlign="left";for(var s=0;s<this.error.length;s++)t.stage.fillText("Error: "+this.error[s],10,20+15*s);if(t.stage.textAlign="center",this.failed.length)if(this.refresh){this.error=["Refreshing..."];for(s=0;s<this.failed.length;s++)this.assets[this.failed[s]].reload();this.failed=[]}else t.stage.font="18px Verdana",t.stage.fillText("Press SPACE to reload failed assets",t.Stage.width/2,t.Stage.height-70)}},t.AssetManager.prototype.isLoaded=function(t){return!!this.loaded[t]},t.AssetManager.prototype.purge=function(){for(var t in this.recurrences)this.recurrences.hasOwnProperty(t)&&clearTimeout(this.recurrences[t]);this.totalLoaded=0,this.totalAssets=0,this.totalMeta=0,this.totalSize=0,this.loadedSize=0,this.assets={},this.loaded={},this.recurrences={},this.error=[],this.failed=[]},t.AssetManager.prototype.loadAsset=function(t){var e=t.name;if(this.assets[e]=t,t.instant)this.loaded[e]=!0;else{var i=this;this.assetAdded(e),this.assets[e].assetOnLoadFunction(function(){i.assetLoaded(e)})||this.assets[e].assetOnFailFunction(function(){i.assetFailed(e)})}},t.AssetManager.prototype.assetAdded=function(t){this.totalAssets++,this.loaded[t]=!1},t.AssetManager.prototype.assetLoaded=function(e){this.assets[e]&&(this.loaded[e]||(this.loaded[e]=!0,this.totalLoaded++,this.finishedLoading()&&t._hardcode_load&&(t.finishInit(),initFinished=!0)))},t.AssetManager.prototype.assetFailed=function(t){var e=t+" failed to load";console.log(e),this.error.push(e),this.failed.push(t)},t.base64ArrayBuffer=function(e){for(var i,s="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",o=new(window[t.prefixed("Uint8Array",window,!1)])(e),a=o.byteLength,r=a%3,h=a-r,l=0;l<h;l+=3)s+=n[(16515072&(i=o[l]<<16|o[l+1]<<8|o[l+2]))>>18]+n[(258048&i)>>12]+n[(4032&i)>>6]+n[63&i];return 1==r?s+=n[(252&(i=o[h]))>>2]+n[(3&i)<<4]+"==":2==r&&(s+=n[(64512&(i=o[h]<<8|o[h+1]))>>10]+n[(1008&i)>>4]+n[(15&i)<<2]+"="),s},t.loadGenericAsset=function(e,i,s){var n=t.assetManager.resolvePath(i),o=i.substring(i.indexOf(".")+1,i.length),a=t.assetManager.mimes[o];if(n in t.assetManager.blobs){var r=window[t.prefixed("URL",window,!1)],h=t.assetManager.blobs[n],l=!1;return l=t.tests.blobrevoke?r.createObjectURL(h,{autoRevoke:!1}):r.createObjectURL(h),void setTimeout(function(){e.success(l,s)},0)}if(n in t.assetManager.cache){l=t.assetManager.cache[n];setTimeout(function(){e.success(l,s)},0)}else if(t.assetManager.ajaxRunning>=t.assetManager.maxAjax)t.assetManager.ajaxCache.push([e,i,s]);else{t.assetManager.ajaxRunning+=1;var u=function(){t.assetManager.ajaxRunning-=1,t.assetManager.ajaxCache.length&&(args=t.assetManager.ajaxCache.shift(),t.loadGenericAsset(args[0],args[1],args[2]))};if([4,5,6,7,8,9,10,11].contains(t.tests.loading))(c=new XMLHttpRequest).total=0,c.loaded=0,c.open("GET",n,!0),[8,9,10,11].contains(t.tests.loading)?c.responseType="blob":c.responseType="arraybuffer",c.onprogress=function(e){if(e.lengthComputable){c.total||(t.assetManager.totalMeta++,t.assetManager.totalSize+=e.total,c.total=e.total);var s=e.loaded-c.loaded;c.loaded=e.loaded,t.assetManager.loadedSize+=s}else console.log("ERROR: Length not computable for "+i)},c.onload=function(){if(200!=this.status&&0!=this.status||!this.response)e.failure(s),u();else{var i=c.total-c.loaded;c.loaded=c.total,t.assetManager.loadedSize+=i;var o=!1;if([5,6,7,9,10,11].contains(t.tests.loading)){var r=window[t.prefixed("URL",window,!1)],h=!1;if(11==t.tests.loading)h=new Blob([this.response],{type:a});else if([5,10].contains(t.tests.loading)){var l=new(window[t.prefixed("BlobBuilder",window,!1)]);l.append(this.response),h=l.getBlob(a)}else if(9==t.tests.loading)h=this.response[t.prefixed("slice",Blob.prototype,!1)](0,this.response.size,a);else if(7==t.tests.loading){var d=new Uint8Array(this.response);h=new Blob([d],{type:a})}else 6==t.tests.loading&&(h=new Blob([this.response],{type:a}));if(!h)return e.failure(s),void u();o=t.tests.blobrevoke?r.createObjectURL(h,{autoRevoke:!1}):r.createObjectURL(h),t.assetManager.blobs[n]=h}else{if(8==t.tests.loading){var f=new FileReader;return f.onload=function(i){var o=i.target.result;if(!o)return e.failure(s),void u();t.assetManager.cache[n]=o,e.success(o,s),u()},f.onabort=function(){e.failure(s)},f.onerror=function(){e.failure(s)},void f.readAsDataURL(this.response)}if(4==t.tests.loading){var p=t.base64ArrayBuffer(this.response);o="data:"+a+";base64,"+p}}if(!o)return e.failure(s),void u();t.assetManager.cache[n]=o,e.success(o,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send();else if([1,2,3].contains(t.tests.loading)){(c=new XMLHttpRequest).open("GET",n,!0),c.overrideMimeType("text/plain; charset=x-user-defined"),c.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)e.failure(s),u();else{var i=!1;if([2,3].contains(t.tests.loading)){for(var o=(f=this.responseText).length,r=new Uint8Array(o),h=0;h<o;h+=1)r[h]=255&f.charCodeAt(h);var l=window[t.prefixed("URL",window,!1)],c=!1;if(3==t.tests.loading)c=new Blob([r],{type:a});else if(2==t.tests.loading){var d=new(window[t.prefixed("BlobBuilder",window,!1)]);d.append(r.buffer),c=d.getBlob(a)}if(!c)return e.failure(s),void u();i=t.tests.blobrevoke?l.createObjectURL(c,{autoRevoke:!1}):l.createObjectURL(c),t.assetManager.blobs[n]=c}else if(1==t.tests.loading){var f;for(o=(f=this.responseText).length,r=new Array(o),h=0;h<o;h+=1)r[h]=255&f.charCodeAt(h);f="";for(h=0;h<o;h+=65e3)f+=String.fromCharCode.apply(null,r.slice(h,Math.min(h+65e3,o)));var p=window.btoa(f);i="data:"+a+";base64,"+p}if(!i)return e.failure(s),void u();t.assetManager.cache[n]=i,e.success(i,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send()}else if(12==t.tests.loading){var c;(c=new XMLHttpRequest).open("GET",n,!0),c.onload=function(){if(200!=this.status&&0!=this.status||!this.responseText)e.failure(s),u();else{for(var i=new VBArray(this.responseBody).toArray(),o=i.length,r="",h=0;h<o;h+=65e3)r+=String.fromCharCode.apply(null,i.slice(h,Math.min(h+65e3,o)));var l=window.btoa(r),c="data:"+a+";base64,"+l;t.assetManager.cache[n]=c,e.success(c,s),u()}},c.onabort=function(){e.failure(s),u()},c.onerror=function(){e.failure(s),u()},c.send()}else 0==t.tests.loading?(t.assetManager.cache[n]=n,e.success(n,s,!0),u()):(console.error("Invalid Sburb.tests.loading. Value = "+t.tests.loading),e.failure(s),u())}},t.createGraphicAsset=function(e,i){var s=new Image;return s.type="graphic",s.name=e,s.originalVals=i,s.success=function(e){var n=i.substring(i.indexOf(".")+1,i.length),o=t.assetManager.mimes[n];s.src=e,"image/gif"==o&&t.Bins.gif.appendChild(s)},s.failure=function(){s.failed=!0},s.onload=function(){s.loaded=!0},s.onerror=s.failure,s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.onload=function(){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1,t.loadGenericAsset(s,i)},s.reload(),s},t.createAudioAsset=function(e,i){if(!Modernizr.audio)return{name:e,type:"audio",originalVals:i,loaded:!0,instant:!0,paused:!0,ended:!0,currentTime:0,duration:0,load:function(){},play:function(){},loop:function(){},pause:function(){},addEventListener:function(){}};var s=new Audio;return s.name=e,s.type="audio",s.preload=!0,s.originalVals=i,s.failure=function(){s.failed=!0},s.isLoaded=function(){s.loaded=!0},s.checkLoaded=function(){s.loaded?delete t.assetManager.recurrences[e]:(s.check_count-=1,4==s.readyState?(delete t.assetManager.recurrences[e],s.isLoaded()):s.check_count?t.assetManager.recurrences[e]=setTimeout(s.checkLoaded,s.check_interval):(delete t.assetManager.recurrences[e],s.failure()))},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.isLoaded=function(){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.success=function(i,n,o){var a=document.createElement("source");a.src=i,s.appendChild(a),s.remaining-=1,s.remaining||(window.chrome&&s.load(),s.addEventListener("loadeddata",s.isLoaded,!1),o||(t.assetManager.recurrences[e]=setTimeout(s.checkLoaded,s.check_interval)))},s.reload=function(){s.remaining=0,s.check_interval=800,s.check_count=5,s.loaded=!1,s.failed=!1;for(var e=0;e<i.length;e++){var n=i[e].substring(i[e].indexOf(".")+1,i[e].length),o=t.assetManager.mimes[n];"audio/mpeg"==o?Modernizr.audio.mp3&&(s.remaining++,t.loadGenericAsset(s,i[e])):"audio/ogg"==o?Modernizr.audio.ogg&&(s.remaining++,t.loadGenericAsset(s,i[e])):(s.remaining++,t.loadGenericAsset(s,i[e]))}},s.reload(),s},t.createMovieAsset=function(e,i){var s={};return s.name=e,s.type="movie",s.originalVals=i,s.done=function(i){s.src=i,t.Bins.movie.innerHTML+='<div id="'+e+'"><object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" codebase="http://fpdownload.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=9,0,0,0" id="movie" width="'+t.Stage.width+'" height="'+t.Stage.height+'"><param name="allowScriptAccess" value="always" /><param name="wmode" value="transparent"/><param name="movie" value="'+s.src+'" /><param name="quality" value="high" /><embed src="'+s.src+'" quality="high" WMODE="transparent" width="'+t.Stage.width+'" height="'+t.Stage.height+'" swLiveConnect="true" id="movie'+e+'" name="movie'+e+'" allowScriptAccess="always" type="application/x-shockwave-flash" pluginspage="http://www.macromedia.com/go/getflashplayer" /></object></div>',document.getElementById(e).style.display="none"},s.success=function(t){s.done(t),s.loaded=!0},s.failure=function(){s.failed=!0},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.success=function(e){s.done(e),s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1,t.loadGenericAsset(s,i)},s.reload(),s},t.createPathAsset=function(t,e){var i=e;return i.name=t,i.type="path",i.instant=!0,i.assetOnLoadFunction=function(t){t&&t()},i.assetOnFailFunction=function(t){return!1},i},t.createFontAsset=function(e,i){var s={font:i[0]};return s.name=e,s.originalVals=i,s.type="font",s.done=function(t){s.loaded=!0},s.failure=function(){s.failed=!0},s.success=function(i,n){var o="url('"+i+"') format('"+s.sources[n]+"')";s.sources[n]=o,s.remaining-=1,s.remaining||(t.Bins.font.innerHTML+='<style type="text/css">@font-face{ font-family: '+s.name+"; src: "+s.sources.join(",")+"; "+s.extra+"}</style>",t.stage.font="10px "+e,s.done())},s.assetOnLoadFunction=function(t){return s.loaded?(t&&t(),!0):(s.done=function(e){s.loaded=!0,t&&t()},!1)},s.assetOnFailFunction=function(t){return s.failed?(t&&t(),!0):(s.failure=function(){!s.failed&&t&&t(),s.failed=!0},!1)},s.reload=function(){s.loaded=!1,s.failed=!1;var e=i.split(",");s.remaining=0,s.sources=[],s.extra="";for(var n=0;n<e.length;n++){var o=e[n].split(":"),a=o[0].trim(),r=o[1].trim();if("url"==a){var h=r.substring(r.indexOf(".")+1,r.length),l="";"ttf"==h?l="truetype":"woff"==h?l="woff":"svg"==h&&(l="svg"),s.remaining+=1,t.loadGenericAsset(s,r,s.sources.length),s.sources.push(l)}else"local"==a?s.sources.push("local('"+r+"')"):"weight"==a&&(s.extra+="font-weight:"+r+"; ")}},s.reload(),s},t.createTextAsset=function(t,e){var i={text:unescape(e).trim()};return i.name=t,i.type="text",i.instant=!0,i.assetOnLoadFunction=function(t){t&&t()},i.assetOnFailFunction=function(t){return!1},i},t}((Sburb=function(t){return t.globalVolume=1,t.Sound=function(t){if(t){this.asset=t;var e=this;window.addEventListener("beforeunload",function(){e.pause()})}},t.Sound.prototype.play=function(t){if(window.chrome){if(this.playedOnce?this.asset.load():this.playedOnce=!0,t){var e=this;this.asset.addEventListener("playing",function(){e.asset.currentTime=t,e.asset.pause(),e.asset.removeEventListener("playing",arguments.callee),e.asset.play()},!1)}}else t&&(this.asset.currentTime=t);this.fixVolume(),this.asset.play()},t.Sound.prototype.pause=function(){this.asset.pause()},t.Sound.prototype.stop=function(){this.pause(),this.asset.currentTime=0},t.Sound.prototype.ended=function(){return this.asset.ended},t.Sound.prototype.fixVolume=function(){this.asset.volume=t.globalVolume},t.BGM=function(e,i,s){t.Sound.call(this,e),this.startLoop=0,this.endLoop=0,this.setLoopPoints(i||0)},t.BGM.prototype=new t.Sound,t.BGM.prototype.setLoopPoints=function(t,e){tmpAsset=this.asset,tmpAsset.addEventListener("ended",function(){tmpAsset.currentTime=t,tmpAsset.play()},!1),this.startLoop=t,this.endLoop=e},t.BGM.prototype.loop=function(){this.play(this.startLoop)},t}((Sburb=function(t){return t.Chooser=function(){this.choosing=!1,this.choices=[],this.choice=0,this.dialogs=[],this.time=0},t.Chooser.prototype.minWidth=160,t.Chooser.prototype.nextChoice=function(){this.choice=(this.choice+1)%this.choices.length},t.Chooser.prototype.prevChoice=function(){this.choice=(this.choice-1+this.choices.length)%this.choices.length},t.Chooser.prototype.beginChoosing=function(e,i){var s,n=this.minWidth,o=new t.FontEngine;for(a=0;a<this.choices.length;a++)n=Math.max(n,(this.choices[a].name.length+3)*o.charWidth+10);s=o.lineHeight*this.choices.length+10,e<t.Stage.x+10&&(e=t.Stage.x+10),i<t.Stage.y+10&&(i=t.Stage.y+10),e+n>t.Stage.x+t.Stage.width-10&&(e=t.Stage.x+t.Stage.width-n-10),i+s>t.Stage.y+t.Stage.height-10&&(i=t.Stage.y+t.Stage.height-s-10),this.choosing=!0,this.choice=0,this.dialogs=[];for(var a=0;a<this.choices.length;a++){var r=new t.FontEngine(" > "+this.choices[a].name);r.showSubText(0,1),r.setDimensions(e,i+a*r.lineHeight),this.dialogs.push(r)}},t.Chooser.prototype.draw=function(){if(this.choosing){t.stage.save();var e,i,s,n,o=this.minWidth;for(e=this.dialogs[0].x,i=this.dialogs[0].y-1,n=0;n<this.dialogs.length;n++)o=Math.max(o,this.dialogs[n].lines[0].length*this.dialogs[n].charWidth+10);for(s=this.dialogs[0].lineHeight*this.dialogs.length,t.stage.fillStyle="#ff9900",t.stage.fillRect(e-6,i-6,o+12,s+13),t.stage.fillStyle="#ffff00",t.stage.fillRect(e-2,i-2,o+4,s+5),t.stage.fillStyle="#000000",t.stage.fillRect(e,i,o,s),n=0;n<this.dialogs.length;n++)this.dialogs[n].draw();t.stage.restore()}},t.Chooser.prototype.update=function(){if(this.choosing){this.time++;for(var e=0;e<this.dialogs.length;e++){var i=this.dialogs[e];i.showSubText(null,i.end+1),e==this.choice?(this.time%t.Stage.fps<t.Stage.fps/2?i.start=2:i.start=0,i.color="#cccccc"):(i.start=0,i.color="#ffffff")}}},t}((Sburb=function(t){function e(t,e){var i=t[e],s=" "+e+"='";return s+=i.hasOwnProperty("x")?i.x+",":"",s+=i.hasOwnProperty("y")?i.y+",":"",s+=i.hasOwnProperty("width")?i.width+",":"",s=(s+=i.hasOwnProperty("height")?i.height+",":"").substring(0,s.length-1),s+="' "}function i(t){var e=t.split(","),i={};switch(e.length){case 4:i.height=parseInt(e[3]);case 3:i.width=parseInt(e[2]);case 2:i.y=parseInt(e[1]);case 1:i.x=parseInt(e[0])}return i}return t.Dialoger=function(e,i,s,n,o,a,r,h,l,u,c,d){this.name="default",this.currentDialog=null,this.talking=!1,this.queue=[],this.extraArgs=null,this.dialog=new t.FontEngine,this.hiddenPos=e,this.alertPos=i,this.talkPosLeft=s,this.talkPosRight=n,this.spriteStartRight=o,this.spriteEndRight=a,this.spriteStartLeft=r,this.spriteEndLeft=h,this.alertTextDimensions=l,this.leftTextDimensions=u,this.rightTextDimensions=c,this.pos={x:e.x,y:e.y},this.actor=null,this.dialogSide="Left",this.graphic=null,this.box=null,this.defaultBox=null,this.type=d,this.handleType(),this.inPosition=!1},t.Dialoger.prototype.dialogSpriteLeft=null,t.Dialoger.prototype.dialogSpriteRight=null,t.Dialoger.prototype.handleType=function(){"social"==this.type&&(this.hashes=new t.FontEngine,this.hashes.setFormatted(!1),this.choices={})},t.Dialoger.prototype.nudge=function(){this.inPosition&&(this.dialog.isShowingAll()?this.dialog.nextBatch()?this.dialog.showSubText(0,1):this.queue.length>0?this.nextDialog():this.talking=!1:this.dialog.showAll())},t.Dialoger.prototype.skipAll=function(){this.talking=!1},t.Dialoger.prototype.startDialog=function(e){this.inPosition=!1,this.actor=null,this.currentDialog=e,this.queue=e.split("@");for(var i=this.queue.length-2;i>=0;i--){for(var s=this.queue[i],n=0,o=s.length-1;o>=0&&"/"==s.charAt(o);)n++,o--;n%2==1&&(this.queue[i]+="@"+this.queue[i+1],this.queue.splice(i+1,1))}"social"==this.type&&this.hashes.setText(""),this.queue.reverse(),this.queue.pop(),this.nextDialog(),"social"==this.type&&(t.buttons.spadeButton.startAnimation("state0"),t.buttons.heartButton.startAnimation("state0"),this.actor&&!this.choices[this.currentDialog]?this.choices[this.currentDialog]=0:1==this.choices[this.currentDialog]?t.buttons.heartButton.startAnimation("state1"):t.buttons.spadeButton.startAnimation("state1")),this.box.x=-this.box.width,this.talking=!0},t.Dialoger.prototype.nextDialog=function(){var e=this.queue.pop().trim();this.dialog.setText(e),this.dialog.showSubText(0,0);var i=e.split(" ",1)[0];if(i.indexOf("~")>=0){var s=i.indexOf("~"),n=i.length,o=i.indexOf("%");o>s&&(n=o),(h=i.indexOf(":"))>=0&&h<n&&(n=h);var a=i.substring(s+1,n);if(i=i.substring(0,s)+i.substring(n,i.length),this.graphic=t.sprites[a],!this.graphic){var r=t.assets[a];this.graphic=new t.Sprite,this.graphic.addAnimation(new t.Animation("image",r,0,0,r.width,r.height,0,1,1)),this.graphic.startAnimation("image")}}else this.graphic=null;if(i.indexOf("%")>=0){var h;s=i.indexOf("%"),n=i.length;(h=i.indexOf(":"))>=0&&h<n&&(n=h);a=i.substring(s+1,n);i=i.substring(0,s)+i.substring(n,i.length),this.setBox(a)}else this.box=this.defaultBox;if(i.indexOf(":")>=0){s=i.indexOf(":"),n=i.length,a=i.substring(s+1,n);i=i.substring(0,s)+i.substring(n,i.length),this.extraArgs=a,"social"==this.type&&this.hashes.setText(this.extraArgs.replace(/#/g," #").replace(/-/g," ").trim())}else this.extraArgs=null,"social"==this.type&&this.hashes.setText("");if("!"==i)this.actor=null,this.dialogSide="Left";else{var l;if(l=i.indexOf("_")>=0?i.substring(0,i.indexOf("_")):i.substring(0,2),null==this.actor){this.dialogSide="Left";var u=this.dialogOnSide(this.dialogSide),c=this.startOnSide(this.oppositeSide(this.dialogSide));u.x=c.x,u.y=c.y}else if(this.actor!=l){this.dialogSide=this.oppositeSide(this.dialogSide);u=this.dialogOnSide(this.dialogSide),c=this.startOnSide(this.dialogSide);u.x=c.x,u.y=c.y}this.actor=l,this.dialogOnSide(this.dialogSide).startAnimation(i)}},t.Dialoger.prototype.oppositeSide=function(t){return"Left"==t?"Right":"Left"},t.Dialoger.prototype.dialogOnSide=function(t){return this["dialogSprite"+t]},t.Dialoger.prototype.startOnSide=function(t){return this["spriteStart"+t]},t.Dialoger.prototype.endOnSide=function(t){return this["spriteEnd"+t]},t.Dialoger.prototype.moveToward=function(t,e,i){return"number"!=typeof i&&(i=100),Math.abs(t.x-e.x)>i?t.x+=i*Math.abs(e.x-t.x)/(e.x-t.x):t.x=e.x,Math.abs(t.y-e.y)>i?t.y+=i*Math.abs(e.y-t.y)/(e.y-t.y):t.y=e.y,t.y==e.y&&t.x==e.x},t.Dialoger.prototype.update=function(){if("social"==this.type)var e=t.buttons.closeButton,i=t.buttons.spadeButton,s=t.buttons.heartButton,n=t.buttons.bubbleButton,o=t.sprites.hashTagBar;if(this.talking){var a,r=!0;null==this.actor?(a=this.alertPos,this.inPosition=!0):(a=this["talkPos"+this.dialogSide],r=this.moveToward(this.dialogOnSide(this.dialogSide),this.endOnSide(this.dialogSide)),this.moveToward(this.dialogOnSide(this.oppositeSide(this.dialogSide)),this.startOnSide(this.oppositeSide(this.dialogSide))));var h=!1;if(this.moveToward(this.pos,a,110)&&r){if(this.dialog.start==this.dialog.end){this.inPosition=!0;var l=this.decideDialogDimensions();this.dialog.setDimensions(l.x,l.y,l.width,l.height),h=!0}this.dialog.showSubText(null,this.dialog.end+2),this.actor&&this.dialogOnSide(this.dialogSide).update(),"social"==this.type&&(0==this.queue.length?null!=this.actor&&(i.update(),s.update(),n.update()):e.update(),o.update())}else this.inPosition=!1;this.graphic&&(this.graphic.x=this.pos.x,this.graphic.y=this.pos.y,this.graphic.update())}else if(this.graphic=null,this.moveToward(this.pos,this.hiddenPos,120),null!=this.actor&&this.moveToward(this.dialogOnSide(this.dialogSide),this.startOnSide(this.oppositeSide(this.dialogSide)))){var u=this.startOnSide(this.dialogSide),c=this.dialogOnSide(this.dialogSide);c.x=u.x,c.y=u.y;var d=this.startOnSide(this.oppositeSide(this.dialogSide)),f=this.dialogOnSide(this.oppositeSide(this.dialogSide));f.x=d.x,f.y=d.y,this.actor=null}this.box.x=this.pos.x,this.box.y=this.pos.y,"social"==this.type&&(o.x=this.pos.x,o.y=this.pos.y+this.box.height,"Right"==this.dialogSide?(i.x=o.x+20,s.x=o.x+60,n.x=o.x+100):(i.x=o.x+o.animation.colSize-120,s.x=o.x+o.animation.colSize-80,n.x=o.x+o.animation.colSize-40),i.y=o.y+15,s.y=o.y+15,n.y=o.y+15,this.actor&&("state1"==t.buttons.spadeButton.animation.name?this.choices[this.currentDialog]=-1:"state1"==t.buttons.heartButton.animation.name?this.choices[this.currentDialog]=1:this.choices[this.currentDialog]=0),h&&(this.dialogSide,this.hashes.setDimensions(this.dialog.x,o.y+13,this.dialog.width,o.animation.rowSize-10)),this.dialog.isShowingAll()&&this.dialog.onLastBatch()?this.hashes.showAll():this.hashes.showSubText(0,0)),this.box.update()},t.Dialoger.prototype.decideDialogDimensions=function(){return null==this.actor?{x:this.pos.x+this.alertTextDimensions.x,y:this.pos.y+this.alertTextDimensions.y,width:this.alertTextDimensions.width,height:this.alertTextDimensions.height}:"Left"==this.dialogSide?{x:this.pos.x+this.leftTextDimensions.x,y:this.pos.y+this.leftTextDimensions.y,width:this.leftTextDimensions.width,height:this.leftTextDimensions.height}:{x:this.pos.x+this.rightTextDimensions.x,y:this.pos.y+this.rightTextDimensions.y,width:this.rightTextDimensions.width,height:this.rightTextDimensions.height}},t.Dialoger.prototype.setBox=function(e){var i=t.sprites[e];if(!i){var s=t.assets[e];(i=new t.Sprite("dialogBox",t.Stage.width+1,1e3,s.width,s.height,null,null,0)).addAnimation(new t.Animation("image",s,0,0,s.width,s.height,0,1,1)),i.startAnimation("image")}this.box?(i.x=this.box.x,i.y=this.box.y):this.defaultBox=i,this.box=i},t.Dialoger.prototype.draw=function(){"social"==this.type&&t.sprites.hashTagBar.draw(),this.box.draw(),this.graphic&&this.graphic.draw(),this.talking&&(this.dialog.draw(),"social"==this.type&&(this.queue.length>0&&t.buttons.closeButton.draw(),this.dialog.start!=this.dialog.end&&(this.hashes.draw(),0==this.queue.length&&null!=this.actor&&(t.buttons.spadeButton.draw(),t.buttons.heartButton.draw(),t.buttons.bubbleButton.draw())))),null!=this.actor&&(this.dialogSpriteLeft.draw(),this.dialogSpriteRight.animation&&(this.dialogSpriteRight.animation.flipX=!0),this.dialogSpriteRight.draw())},t.parseDialoger=function(e){var s=e.attributes,n=i(s.getNamedItem("hiddenPos").value),o=i(s.getNamedItem("alertPos").value),a=i(s.getNamedItem("talkPosLeft").value),r=i(s.getNamedItem("talkPosRight").value),h=i(s.getNamedItem("spriteStartRight").value),l=i(s.getNamedItem("spriteEndRight").value),u=i(s.getNamedItem("spriteStartLeft").value),c=i(s.getNamedItem("spriteEndLeft").value),d=i(s.getNamedItem("alertTextDimensions").value),f=i(s.getNamedItem("leftTextDimensions").value),p=i(s.getNamedItem("rightTextDimensions").value),g=s.getNamedItem("type")?s.getNamedItem("type").value:"standard",m=new t.Dialoger(n,o,a,r,h,l,u,c,d,f,p,g),y=s.getNamedItem("box").value;return m.setBox(y),m},t.Dialoger.prototype.serialize=function(i){return i+="\n<dialoger "+function(t){str="";for(var i=1;i<arguments.length;i++)str=str.concat(e(t,arguments[i]));return str}(this,"hiddenPos","alertPos","talkPosLeft","talkPosRight","spriteStartRight","spriteEndRight","spriteStartLeft","spriteEndLeft","alertTextDimensions","leftTextDimensions","rightTextDimensions"),i+=t.serializeAttribute(this,"type"),i+="box='"+this.box.animation.sheet.name+"' ",i+=">",i+="</dialoger>"},t}((Sburb=function(t){t.loadedFiles={};var e={},i=0,s=[],n=null;function o(e,o){t.haltUpdateProcess();var a=e,h=t.parseXML(a);o||(t.assetManager.purge(),t.assets=t.assetManager.assets,function(){for(var e in t.rooms&&delete t.rooms,t.sprites&&delete t.sprites,t.rooms={},t.bgm&&(t.bgm.stop(),t.bgm=null),t.Bins)t.Bins.hasOwnProperty(e)&&(t.Bins[e].innerHTML="");t.gameState={},t.globalVolume=1,t.hud={},t.sprites={},t.buttons={},t.effects={},t.curAction=null,t.actionQueues=[],t.nextQueueId=0,t.pressed={},t.pressedOrder=[],t.chooser=new t.Chooser,t.dialoger=null,t.curRoom=null,t.char=null,t.assetManager.resourcePath="",t.assetManager.levelPath="",t.loadedFiles={}}());var d=h.attributes,g=d.getNamedItem("levelPath");g&&(t.assetManager.levelPath="/"==g.value.charAt(g.value.length-1)?g.value:g.value+"/");var A=d.getNamedItem("resourcePath");A&&(t.assetManager.resourcePath=A.value);var I=d.getNamedItem("name");I&&(t.name=I.value);var M=d.getNamedItem("version");M&&(t.version=M.value);var N=d.getNamedItem("width");N&&t.setDimensions(N.value,null);var T=d.getNamedItem("height");T&&t.setDimensions(null,T.value);var C=d.getNamedItem("loadedFiles");if(C)for(var B=C.value.split(","),R=0;R<B.length;R++)t.loadedFiles[B[R]]=!0;i++,function(e){var i=e.getElementsByTagName("dependencies")[0];if(i)for(var s=i.getElementsByTagName("dependency"),n=0;n<s.length;n++){var o=s[n].firstChild.nodeValue.trim();t.loadSerialFromXML(o,!0)}}(h),i--,function(e){var i=e.attributes.getNamedItem("description");t.assetManager.description=i?i.value:"assets";for(var s=e.getElementsByTagName("asset"),n=0;n<s.length;n++){var o=s[n],a=o.attributes,h=a.getNamedItem("name").value;t.assetManager.isLoaded(h)||r(o)}}(h),s.push(h),function e(){n&&(clearTimeout(n),n=null);if(!t.assetManager.finishedLoading())return void(n=setTimeout(function(){e()},500));for(;s.length>0;){var o=s[0];s.splice(0,1),u(o),c(o),f(o),p(o),m(o),y(o),v(o),w(o),S(o),l(o),b(o),x(o)}0==s.length&&0==i&&t.startUpdateProcess()}()}function a(t,e){this.name="XMLParsingError",this.message=function t(e){if(3==e.nodeType)return e.nodeValue;if("h3"==e.nodeName)return"";var i="";for(var s=0;s<e.childNodes.length;s++)i+=t(e.childNodes[s]);return i}(t),this.input=e||""}function r(e){var i=function(e){var i,s=e.attributes,n=s.getNamedItem("name").value,o=s.getNamedItem("type").value,a=e.firstChild.nodeValue.trim(),r=s.getNamedItem("blob-urls"),h=[];r&&(h=r.value.split(";"));0===h.length&&(h=null);if("graphic"==o)i=t.createGraphicAsset(n,a,h);else if("audio"==o){var l=a.split(";");i=t.createAudioAsset(n,l,h)}else if("path"==o){for(var u=a.split(";"),c=new t.Path,d=0;d<u.length;d++){var f=u[d].split(",");c.push({x:parseInt(f[0]),y:parseInt(f[1])})}i=t.createPathAsset(n,c)}else"movie"==o?i=t.createMovieAsset(n,a,h):"font"==o?i=t.createFontAsset(n,a):"text"==o&&(i=t.createTextAsset(n,a));return i._raw_xml=e,i}(e);t.assetManager.loadAsset(i)}function h(e){var i=e.getElementsByTagName("hud");if(i.length>0){var s=i[0].getElementsByTagName("dialogsprites");s.length>0&&function(e,i){t.dialoger||(t.dialoger={});t.dialoger.dialogSpriteLeft||(t.dialoger.dialogSpriteLeft=new t.Sprite("dialogSprite",-1e3,t.Stage.height,0,0),t.dialoger.dialogSpriteRight=new t.Sprite("dialogSprite",t.Stage.width+1e3,t.Stage.height,0,0));for(var s=e.getElementsByTagName("animation"),n=0;n<s.length;n++)t.dialoger.dialogSpriteLeft.addAnimation(t.parseAnimation(s[n],i)),t.dialoger.dialogSpriteRight.addAnimation(t.parseAnimation(s[n],i))}(s[0],t.assets)}}function l(e){var i=e.getElementsByTagName("effects");i.length>0&&function(e,i,s){for(var n=e.getElementsByTagName("animation"),o=0;o<n.length;o++){var a=t.parseAnimation(n[o],i);s[a.name]=a}}(i[0],t.assets,t.effects)}function u(t){var i=t.getElementsByTagName("classes");if(i.length>0){for(var s=i[0].childNodes,n=0;n<s.length;n++){var o=s[n];if("#text"!=o.nodeName&&"#comment"!=o.nodeName){c(o);var a=o.attributes;e[a.getNamedItem("class").value]=o.cloneNode(!0)}}t.removeChild(t.getElementsByTagName("classes")[0])}}function c(t){for(var i in e)if(e.hasOwnProperty(i))for(var s=e[i],n=t.getElementsByTagName(s.nodeName),o=0;o<n.length;o++){d(s,n[o])}}function d(t,e){var i=t.attributes.getNamedItem("class").value,s=e.attributes.getNamedItem("class");s&&s.value==i&&function(t,e){for(var i=t.attributes,s=t.childNodes,n=e.attributes,o=(e.childNodes,0);o<i.length;o++){var a=i[o];n.getNamedItem(a.name)||e.setAttribute(a.name,a.value)}for(var o=0;o<s.length;o++)e.appendChild(s[o].cloneNode(!0))}(t,e)}function f(e){for(var i=e.getElementsByTagName("spritebutton"),s=0;s<i.length;s++){var n=i[s],o=t.parseSpriteButton(n);t.buttons[o.name]=o}}function p(e){for(var i=e.getElementsByTagName("sprite"),s=0;s<i.length;s++){var n=i[s],o=t.parseSprite(n,t.assets);t.sprites[o.name]=o,g(n,o)}}function g(e,i){for(var s=e.childNodes,n=0;n<s.length;n++)if("#text"!=s[n].nodeName&&"action"==s[n].nodeName){var o=t.parseAction(s[n]);i.addAction(o)}}function m(e){for(var i=e.getElementsByTagName("character"),s=0;s<i.length;s++){var n=i[s],o=t.parseCharacter(n,t.assets);t.sprites[o.name]=o,g(n,o)}}function y(e){for(var i=e.getElementsByTagName("fighter"),s=0;s<i.length;s++){var n=i[s],o=t.parseFighter(n,t.assets);t.sprites[o.name]=o,g(n,o)}}function v(e){for(var i=e.getElementsByTagName("room"),s=0;s<i.length;s++){var n=i[s],o=t.parseRoom(n,t.assets,t.sprites);t.rooms[o.name]=o}}function w(e){for(var i=e.getElementsByTagName("gameState"),s=0;s<i.length;s++)for(var n=i[s].childNodes,o=0;o<n.length;o++){var a=n[o];if(3!==a.nodeType){var r=a.tagName,h=a.firstChild.nodeValue;t.gameState[r]=h}}}function x(e){var i=e.getElementsByTagName("actionQueues");if(0!=i.length)for(var s=i[0].childNodes,n=0;n<s.length;n++)if("#text"!=s[n].nodeName){var o=t.parseActionQueue(s[n]);t.actionQueues.push(o)}}function b(e){var i=e.attributes,s=i.getNamedItem("char");s&&(t.focus=t.char=t.sprites[s.value],t.char.becomePlayer());var n=i.getNamedItem("mode");n&&(t.engineMode=n.value);var o=i.getNamedItem("scale");o&&(t.Stage.scaleX=t.Stage.scaleY=parseInt(o.value));var a=i.getNamedItem("nextQueueId");a&&(t.nextQueueId=parseInt(a.value));var r=i.getNamedItem("curRoom");if(r)t.curRoom=t.rooms[r.value],t.curRoom.enter();else if(null==t.curRoom&&null!=t.char)for(var h in t.rooms)if(t.rooms.hasOwnProperty(h)){var l=t.rooms[h];if(l.contains(t.char)){t.curRoom=l,t.curRoom.enter();break}}var u,c,d=i.getNamedItem("bgm");if(d){var f=d.value.split(",");t.changeBGM(new t.BGM(t.assets[f[0]],parseFloat(f.length>1?f[1]:"0")))}if(i.getNamedItem("startAction")){c=i.getNamedItem("startAction").value;for(var p=0;p<e.childNodes.length;p++){var g=e.childNodes[p];"action"!=g.tagName||g.attributes.getNamedItem("name").value!=c||(u=t.parseAction(g))}u&&t.performAction(u)}}function S(e){var i=e.getElementsByTagName("hud");if(i.length>0)for(var s=i[0].childNodes,n=0;n<s.length;n++){var o=s[n];if("spritebutton"==o.nodeName){var a=o.attributes.getNamedItem("name").value;t.hud[a]=t.buttons[a]}}!function(e){var i=e.getElementsByTagName("dialoger");if(i.length>0){var s=null,n=null;t.dialoger&&(s=t.dialoger.dialogSpriteLeft,n=t.dialoger.dialogSpriteRight),t.dialoger=t.parseDialoger(i[0]),t.dialoger.dialogSpriteLeft=s,t.dialoger.dialogSpriteRight=n}}(e),h(e)}return t.serialize=function(i){var s=i.assets,n=i.effects,o=i.rooms,a=i.sprites,r=i.hud,h=i.dialoger,l=(i.curRoom,i.gameState),u=i.actionQueues,c=i.char,d="",f=!1;for(var p in t.loadedFiles)t.loadedFiles.hasOwnProperty(p)&&(d=d+(f?",":"")+p,f=!0);var g=document.getElementById("serialText"),m="<sburb char='"+c.name+(t.bgm?"' bgm='"+t.bgm.asset.name+(t.bgm.startLoop?","+t.bgm.startLoop:""):"")+(1!=t.Stage.scaleX?"' scale='"+t.Stage.scaleX:"")+(t.nextQueueId>0?"' nextQueueId='"+t.nextQueueId:"")+(t.assetManager.resourcePath?"' resourcePath='"+t.assetManager.resourcePath:"")+(t.assetManager.levelPath?"' levelPath='"+t.assetManager.levelPath:"")+(f?"' loadedFiles='"+d:"")+"'>\n";return m=(m=function(t,e){t=t.concat("<actionQueues>");for(var i=0;i<e.length;i++)e[i].curAction&&(t=e[i].serialize(t));return t=t.concat("\n</actionQueues>\n")}(m=function(t,e){for(var i in t=t.concat("\n<gameState>\n"),e)e.hasOwnProperty(i)&&(t=t.concat("  <"+i+">"+e[i].replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")+"</"+i+">"));return t=t.concat("\n</gameState>\n")}(m=function(t,e){for(var i in t=t.concat("\n<rooms>\n"),e)e.hasOwnProperty(i)&&(t=e[i].serialize(t));return t=t.concat("\n</rooms>\n")}(m=function(e,i,s){for(var n in s)if(s.hasOwnProperty(n)){var o=s[n],a=!1;for(var r in i)if(i.hasOwnProperty(r)&&i[r].contains(o)){a=!0;break}a||(e=o.serialize(e))}for(var h in t.buttons)if(t.buttons.hasOwnProperty(h)){var l=t.buttons[h];t.hud[l.name]||(e=l.serialize(e))}return e}(m=function(e,i,s){for(var n in e=e.concat("\n<hud>"),i)i.hasOwnProperty(n)&&(e=i[n].serialize(e));e=t.dialoger.serialize(e);var o=s.dialogSpriteLeft.animations;for(var a in e=e.concat("\n<dialogsprites>"),o)o.hasOwnProperty(a)&&(e=o[a].serialize(e));return e=(e=e.concat("\n</dialogsprites>")).concat("\n</hud>\n")}(m=function(t,e){t=t.concat("\n<classes>");try{for(var i in serializer=new XMLSerializer,e)e.hasOwnProperty(i)&&(t=t.concat(serializer.serializeToString(e[i])))}catch(s){for(var i in e)e.hasOwnProperty(i)&&(t=t.concat(e[i].xml))}return t=t.concat("\n</classes>\n")}(m=function(t,e,i){for(var s in t=t.concat("\n<assets>"),e)if(e.hasOwnProperty(s)){var n=e[s],o="";if("graphic"==n.type)o+=n.originalVals;else if("audio"==n.type)for(var a=!1,r=0;r<n.originalVals.length;r++){var h=n.originalVals[r];o+=(a?";":"")+h,a=!0}else if("path"==n.type)for(var r=0;r<n.points.length;r++)o=o.concat(n.points[r].x+","+n.points[r].y),r!=n.points.length-1&&(o=o.concat(";"));else"movie"==n.type?o+=n.originalVals:"font"==n.type?o+=n.originalVals:"text"==n.type&&(o+=escape(n.text.trim()));t=(t=(t=(t=t.concat("\n<asset name='"+n.name+"' type='"+n.type+"' ")).concat(" >")).concat(o)).concat("</asset>")}for(var l in t=(t=t.concat("\n</assets>\n")).concat("\n<effects>"),i)if(i.hasOwnProperty(l)){var u=i[l];t=u.serialize(t)}return t=t.concat("\n</effects>\n")}(m,s,n),e),r,h),o,a),o),l),u)).concat("\n</sburb>"),g&&(g.value=m),m},t.saveStateToStorage=function(e,i,s){var n;if(e=void 0!==e?e:"SaveFile",i=void 0!==i&&i,s=void 0!==s&&s,!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)n=s?localStorage:sessionStorage;else if(t.tests.storage.local)n=localStorage;else{if(!t.tests.storage.session)return!1;n=sessionStorage}var o=t.serialize(t);compressed=Iuppiter.Base64.encode(Iuppiter.compress(o),!0);var a=e+(i?" (auto)":"")+"_savedState_"+t.name+":"+t.version;return t.deleteStateFromStorage(i),n.setItem(a,compressed),!0},t.loadStateFromStorage=function(e,i){var s;if(description="undefined"!=typeof description?description:"SaveFile",e=void 0!==e&&e,i=void 0!==i&&i,!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return!1;s=sessionStorage}var n="";for(var o in s)if(s.hasOwnProperty(o)){var a=o.indexOf("_savedState_");if(a>=0){if(e&&o.indexOf("(auto)")>=0&&o.indexOf(t.name+":"+t.version)>=a){n=o;break}if(!e&&o.indexOf("(auto)")<0&&o.indexOf(t.name+":"+t.version)>=a){n=o;break}}}var r=s.getItem(n);if(!r)return!1;var h=Iuppiter.decompress(Iuppiter.Base64.decode(Iuppiter.toByteArray(r),!0)).replace(/\0/g,"");return t.loadSerial(h),!0},t.getStateDescription=function(e,i){var s;if(e=void 0!==e&&e,i=void 0!==i&&i,!t.tests.storage)return null;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return null;s=sessionStorage}for(var n in s)if(s.hasOwnProperty(n)){var o=n.indexOf("_savedState_");if(o>=0){if(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=o)return n.substring(0,o);if(!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=o)return n.substring(0,o)}}return null},t.deleteStateFromStorage=function(e,i){var s;if(e=void 0!==e&&e,i=void 0!==i&&i,t.tests.storage){if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return;s=sessionStorage}for(var n in t.deleteOldVersionStates(i),s)if(s.hasOwnProperty(n)){var o=n.indexOf("_savedState_");o>=0&&(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=o?s.removeItem(n):!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=o&&s.removeItem(n))}}},t.deleteOldVersionStates=function(e){var i;if(e=void 0!==e&&e,t.tests.storage){if(t.tests.storage.local&&t.tests.storage.session)i=e?localStorage:sessionStorage;else if(t.tests.storage.local)i=localStorage;else{if(!t.tests.storage.session)return;i=sessionStorage}for(var s in i)if(i.hasOwnProperty(s)){var n=s.indexOf("_savedState_");n>=0&&s.indexOf(t.name+":")>=n&&s.indexOf(":"+t.version)<0&&i.removeItem(s)}}},t.isStateInStorage=function(e,i){var s;if(e=void 0!==e&&e,i=void 0!==i&&i,!t.tests.storage)return!1;if(t.tests.storage.local&&t.tests.storage.session)s=i?localStorage:sessionStorage;else if(t.tests.storage.local)s=localStorage;else{if(!t.tests.storage.session)return!1;s=sessionStorage}for(var n in s)if(s.hasOwnProperty(n)){var o=n.indexOf("_savedState_");if(o>=0){if(e&&n.indexOf("(auto)")>=0&&n.indexOf(t.name+":"+t.version)>=o)return!0;if(!e&&n.indexOf("(auto)")<0&&n.indexOf(t.name+":"+t.version)>=o)return!0}}return!1},t.loadSerialFromXML=function(e,i){if(t.haltUpdateProcess(),e=t.assetManager.levelPath+e,i&&t.loadedFiles[e])t.startUpdateProcess();else{t.loadedFiles[e]=!0;var s=new XMLHttpRequest;s.open("GET",e,!1);try{s.send(null)}catch(t){return console.log("Could not load level descriptors."),void(fi=document.getElementById("levelFile"))}if(200===s.status||0==s.status)try{o(s.responseText,i)}catch(t){throw t instanceof a&&(t.file?console.error("Loaded from '"+e+"'"):(t.file=e,console.error("Error in '"+e+"'"))),t}}},t.parseXML=function(t){var e=(new DOMParser).parseFromString(t,"text/xml");if(e.getElementsByTagName("parsererror").length>0)throw new a(e.getElementsByTagName("parsererror")[0],t);return e.documentElement},a.prototype=new Error,t.serializeAttribute=function(t,e){return t[e]?" "+e+"='"+t[e]+"' ":""},t.serializeAttributes=function(e){str="";for(var i=1;i<arguments.length;i++)str=str.concat(t.serializeAttribute(e,arguments[i]));return str},t.serialLoadRoomSprites=function(t,e,i){for(var s=0;s<e.length;s++){var n=i[e[s].attributes.getNamedItem("name").value];t.addSprite(n)}},t.serialLoadRoomPaths=function(t,e,i){for(var s=e[0].getElementsByTagName("walkable"),n=0;n<s.length;n++){var o=s[n].attributes;t.addWalkable(i[o.getNamedItem("path").value])}var a=e[0].getElementsByTagName("unwalkable");for(n=0;n<a.length;n++)o=a[n].attributes,t.addUnwalkable(i[o.getNamedItem("path").value]);var r=e[0].getElementsByTagName("motionpath");for(n=0;n<r.length;n++)o=r[n].attributes,t.addMotionPath(i[o.getNamedItem("path").value],o.getNamedItem("xtox")?parseFloat(o.getNamedItem("xtox").value):1,o.getNamedItem("xtoy")?parseFloat(o.getNamedItem("xtoy").value):0,o.getNamedItem("ytox")?parseFloat(o.getNamedItem("ytox").value):0,o.getNamedItem("ytoy")?parseFloat(o.getNamedItem("ytoy").value):1,o.getNamedItem("dx")?parseFloat(o.getNamedItem("dx").value):0,o.getNamedItem("dy")?parseFloat(o.getNamedItem("dy").value):0)},t.serialLoadRoomTriggers=function(e,i){for(var s=i[0].childNodes,n=0;n<s.length;n++)"trigger"==s[n].nodeName&&e.addTrigger(t.parseTrigger(s[n]))},t.loadSerial=o,t}((Sburb=function(t){function e(t){for(var e=t.split(","),i=0;i<e.length;i++)e[i]=e[i].trim();return e}var i={talk:function(e){t.dialoger.startDialog(e)},randomTalk:function(e){t.dialoger.startDialog(e);var i=Math.floor(Math.random()*(t.dialoger.queue.length+1));i?(t.dialoger.queue=[t.dialoger.queue[i-1]],t.dialoger.nextDialog()):t.dialoger.queue=[]},changeRoom:function(i){var s=e(i);t.changeRoom(t.rooms[s[0]],parseInt(s[1]),parseInt(s[2])),t.loadingRoom=!1},changeFocus:function(i){var n=e(i);if("null"==n[0])t.focus=t.destFocus=null;else{var o=s(n[0]);t.destFocus=o}},teleport:function(s){i.changeRoom(s),t.playEffect(t.effects.teleportEffect,t.char.x,t.char.y);var n=e(s);t.curAction.followUp=new t.Action("playEffect","teleportEffect,"+n[1]+","+n[2],null,null,t.curAction.followUp)},changeChar:function(e){t.char.becomeNPC(),t.char.moveNone(),t.char.walk(),t.destFocus=t.char=t.sprites[e],t.char.becomePlayer(),t.setCurRoomOf(t.char)},playSong:function(i){var s=e(i);t.changeBGM(new t.BGM(t.assets[s[0]],parseFloat(s[1])))},becomeNPC:function(e){t.char.becomeNPC()},becomePlayer:function(e){t.char.becomePlayer()},playSound:function(e){t.playSound(new t.Sound(t.assets[e.trim()]))},playEffect:function(i){var s=e(i);t.playEffect(t.effects[s[0]],parseInt(s[1]),parseInt(s[2]))}};i.playAnimation=i.startAnimation=function(t){var i=e(t);s(i[0]).startAnimation(i[1])},i.addAction=i.addActions=function(t){for(var i=e(t),o=t.indexOf(","),a=s(i[0]),r=n(t.substring(o+1,t.length)),h=0;h<r.length;h++){var l=r[h];a.addAction(l)}},i.removeAction=i.removeActions=function(t){for(var i=e(t),n=s(i[0]),o=1;o<i.length;o++)n.removeAction(i[o])},i.presentAction=i.presentActions=function(e){var i=n(e);t.chooser.choices=i,t.chooser.beginChoosing(t.Stage.x+20,t.Stage.y+50)},i.openChest=function(e){var s=e.split(",",2),n=t.sprites[s[0].trim()],o=t.sprites[s[1].trim()];n.animations.open&&(n.startAnimation("open"),t.assets.openSound&&i.playSound("openSound")),n.removeAction(t.curAction.name);var a,r=s[0].length+s[1].length+2,h=e.substring(r,e.length).trim();h="@"==h.charAt(0)?h:"@! "+h;var l=a=new t.Action("waitFor","played,"+n.name,null,null);a=(a=(a=(a=a.followUp=new t.Action("waitFor","time,13")).followUp=new t.Action("addSprite",o.name+","+t.curRoom.name,null,null,null,!0)).followUp=new t.Action("moveSprite",o.name+","+n.x+","+(n.y-60),null,null,null,!0,!0)).followUp=new t.Action("deltaSprite",o.name+",0,-3",null,null,null,!0,null,10),t.assets.itemGetSound&&(a=a.followUp=new t.Action("playSound","itemGetSound",null,null,null,!0,null)),(a=(a=(a=a.followUp=new t.Action("waitFor","time,30")).followUp=new t.Action("talk",h)).followUp=new t.Action("removeSprite",o.name+","+t.curRoom.name)).followUp=t.curAction.followUp,t.performAction(l)},i.deltaSprite=function(i){var s=e(i),n=null;n="char"==s[0]?t.char:t.sprites[s[0]];var o=parseInt(s[1]),a=parseInt(s[2]);n.x+=o,n.y+=a},i.moveSprite=function(t){var i=e(t),n=s(i[0]),o=parseInt(i[1]),a=parseInt(i[2]);n.x=o,n.y=a},i.depthSprite=function(t){var i=e(t),n=s(i[0]),o=parseInt(i[1]);n.depthing=o},i.playMovie=function(s){var n=e(s);if(t.playMovie(t.assets[n[0]]),n.length>0)var o=setInterval(function(){var t=window.document.getElementById("movie"+n[0]);t&&(!t.CurrentFrame||t.CurrentFrame()>=4)&&(clearInterval(o),i.playSong(s.substring(s.indexOf(",")+1,s.length)))},10)},i.removeMovie=function(e){t.playingMovie=!1,t.draw(),document.getElementById(e).style.display="none"},i.disableControl=function(e){t.inputDisabled=!(e.trim().length>0)||new t.Trigger(e)},i.enableControl=function(e){t.inputDisabled=!1},i.waitFor=function(t){return i.disableControl(t),i.sleep(t)},i.macro=function(e){var i=n(e)[0];i.silent||(i.silent=!0);var s=t.performAction(i);if(s)return new t.Trigger("noActions,"+s.id)},i.sleep=function(e){return new t.Trigger(e)},i.pauseActionQueue=i.pauseActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++){var o=t.getActionQueueById(s[n]);o&&(o.paused=!0)}},i.resumeActionQueue=i.resumeActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++){var o=t.getActionQueueById(s[n]);o&&(o.paused=!1)}},i.cancelActionQueue=i.cancelActionQueues=function(i){for(var s=e(i),n=0;n<s.length;n++)t.removeActionQueueById(s[n])},i.pauseActionQueueGroup=i.pauseActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.forEachActionQueueInGroup(s[n],function(t){t.paused=!0})},i.resumeActionQueueGroup=i.resumeActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.forEachActionQueueInGroup(s[n],function(t){t.paused=!1})},i.cancelActionQueueGroup=i.cancelActionQueueGroups=function(i){for(var s=e(i),n=0;n<s.length;n++)t.removeActionQueuesByGroup(s[n])},i.addSprite=function(i){var s=e(i),n=t.sprites[s[0]];t.rooms[s[1]].addSprite(n)},i.removeSprite=function(i){var s=e(i),n=t.sprites[s[0]];t.rooms[s[1]].removeSprite(n)},i.cloneSprite=function(t){var i=e(t),n=s(i[0]),o=i[1];n.clone(o)},i.addWalkable=function(i){var s=e(i),n=t.assets[s[0]];t.rooms[s[1]].addWalkable(n)},i.addUnwalkable=function(i){var s=e(i),n=t.assets[s[0]];t.rooms[s[1]].addUnwalkable(n)},i.addMotionPath=function(i){var s=e(i),n=t.assets[s[0]];t.rooms[s[7]].addMotionPath(n,parseFloat(s[1]),parseFloat(s[2]),parseFloat(s[3]),parseFloat(s[4]),parseFloat(s[5]),parseFloat(s[6]))},i.removeWalkable=function(i){var s=e(i),n=t.assets[s[0]];t.rooms[s[1]].removeWalkable(n)},i.removeUnwalkable=function(i){var s=e(i),n=t.assets[s[0]];t.rooms[s[1]].removeUnwalkable(n)},i.toggleVolume=function(){t.globalVolume>=1?t.globalVolume=0:t.globalVolume>=.6?t.globalVolume=1:t.globalVolume>=.3?t.globalVolume=.66:t.globalVolume=.33,t.bgm&&t.bgm.fixVolume()},i.changeMode=function(e){t.engineMode=e.trim()},i.loadStateFile=function(i){var s=e(i),n=s[0],o="true"==s[1];t.loadSerialFromXML(n,o)},i.fadeOut=function(e){t.fading=!0},i.changeRoomRemote=function(i){if(!t.loadingRoom){t.loadingRoom=!0;var s,n=e(i),o=s=new t.Action("fadeOut");(s=(s=s.followUp=new t.Action("loadStateFile",n[0]+","+!0)).followUp=new t.Action("changeRoom",n[1]+","+n[2]+","+n[3])).followUp=t.curAction.followUp,t.performAction(o)}},i.teleportRemote=function(s){if(!t.loadingRoom){t.loadingRoom=!0,i.changeRoomRemote(s),t.playEffect(t.effects.teleportEffect,t.char.x,t.char.y);var n=e(s);t.curAction.followUp.followUp.followUp=new t.Action("playEffect","teleportEffect,"+n[2]+","+n[3],null,null,t.curAction.followUp.followUp.followUp)}},i.setButtonState=function(i){var s=e(i);t.buttons[s[0]].setState(s[1])},i.skipDialog=function(e){t.dialoger.skipAll()},i.follow=function(t){var i=e(t),n=s(i[0]),o=s(i[1]);n.follow(o)},i.unfollow=function(t){var i=e(t);s(i[0]).unfollow()},i.addOverlay=function(i){var s=e(i),n=t.sprites[s[0]];n.x=t.Stage.x,n.y=t.Stage.y,t.curRoom.addSprite(n)},i.removeOverlay=function(i){var s=e(i),n=t.sprites[s[0]];t.curRoom.removeSprite(n)},i.save=function(i){var s=e(i),n=s.length>0&&"true"==s[0],o=s.length>1&&"true"==s[1];t.saveStateToStorage(t.char.name+", "+t.curRoom.name,n,o)},i.load=function(i){var s=e(i),n=s.length>0&&"true"==s[0],o=s.length>1&&"true"==s[1];t.loadStateFromStorage(n,o)},i.saveOrLoad=function(i){var s=e(i),n=s.length>0&&"true"==s[0],o=[];t.isStateInStorage(!1,n)&&o.push(new t.Action("load","false, "+n,"Load "+t.getStateDescription(!1))),t.isStateInStorage(!0,n)&&o.push(new t.Action("load","true, "+n,"Load "+t.getStateDescription(!0))),t.tests.storage&&o.push(new t.Action("save","false,"+n,"Save")),o.push(new t.Action("cancel",null,"Cancel")),t.chooser.choices=o,t.chooser.beginChoosing(t.Stage.x+20,t.Stage.y+50)},i.setGameState=function(i){var s=e(i);t.gameState[s[0]]=s[1]},i.goBack=function(t){var i=e(t),n=s(i[0]);n.x=n.oldX,n.y=n.oldY},i.try=function(e){for(var i=function(e){var i=[];e="<triggers>"+e+"</triggers>";for(var s=t.parseXML(e),n=0;n<s.childNodes.length;n++){var o=s.childNodes[n];"trigger"==o.tagName&&i.push(t.parseTrigger(o))}return i}(e),s=0;s<i.length;s++){var n=i[s];if(n.detonate=!0,n.tryToTrigger())return}},i.walk=function(t){var i=e(t),n=s(i[0]),o=i[1];"function"==typeof n["move"+o]&&n["move"+o]()},i.openLink=function(i){var s,n=e(i),o=n[0];s=n[1]&&""!=n[1]?n[1]:o;var a=[];a.push(new t.Action("openDirect",o+","+s,"Go To "+s)),a.push(new t.Action("cancel",null,"Cancel")),t.chooser.choices=a,t.chooser.beginChoosing(t.Stage.x+200,t.Stage.y+250)},i.openDirect=function(t){var i=e(t),s=function(t){if(0==t.indexOf("/"))return t.substr(1);if(-1==t.indexOf("://"))return"http://"+t;return t}(i[0]),n=i[1];window.open(s,n,"menubar=yes,location=yes,resizable=yes,scrollbars=yes,status=yes")},i.cancel=function(){};var s=t.parseCharacterString=function(e){return"char"==e?t.char:t.sprites[e]};function n(e){var i=[];e="<sburb>"+e+"</sburb>";for(var s=t.parseXML(e),n=0;n<s.childNodes.length;n++){var o=s.childNodes[n];"action"==o.tagName&&i.push(t.parseAction(o))}return i}return t.commands=i,t}((Sburb=function(t){function e(t){if(!t)return[];for(var e=[],i=0;i<t.childNodes.length;i++){var s=t.childNodes[i];if("args"==s.tagName){for(var n=0;n<s.childNodes.length;n++)if(s.childNodes[n].firstChild){serializer=new XMLSerializer;for(var o="",a=0;a<s.childNodes.length;a++)o+=serializer.serializeToString(s.childNodes[a]);e.push(o)}void 0!==s.textContent?e.push(s.textContent):e.push(s.firstChild.nodeValue)}}return 0==e.length&&e.push(t.firstChild.nodeValue),e}return t.Trigger=function(e,i,s,n,o,a){"string"==typeof e&&(e=[e]),this.info=e,this.followUp=s||null,this.action=i||null,this.restart=n||!1,this.detonate=o||!1,this.operator=a?a.toUpperCase():"AND",this.waitFor=null,this.events=[];for(var r=0;r<e.length;r++){var h=this.info[r].trim(),l=h.split(",")[0];this.events[r]=new t.events[l](h)}this.reset()},t.Trigger.prototype.reset=function(){for(var t=0;t<this.events.length;t++)this.events[t].reset()},t.Trigger.prototype.checkCompletion=function(){return this["operator"+this.operator]()},t.Trigger.prototype.tryToTrigger=function(){if(this.waitFor){if(!this.waitFor.checkCompletion())return;this.waitFor=null}if(this.checkCompletion()){if(this.action){var e=t.performAction(this.action);this.waitFor=e?new t.Trigger("noActions,"+e.id):new t.Trigger("noActions")}return this.followUp&&this.followUp.tryToTrigger()&&(this.followUp=null),this.restart&&reset(),this.detonate}},t.Trigger.prototype.serialize=function(t){t=t.concat("\n<trigger"+(this.restart?" restart='true'":"")+(this.detonate?" detonate='true'":"")+(this.operator?" operator='"+this.operator+"'":"")+">");for(var e=0;e<this.info.length;e++)t=this.events[e].serialize?t.concat("<args>"+escape(this.events[e].serialize())+"</args>"):t.concat("<args>"+escape(this.info[e])+"</args>");return this.action&&(t=this.action.serialize(t)),this.followUp&&(t=this.followUp.serialize(t)),t=t.concat("\n</trigger>")},t.Trigger.prototype.operatorAND=function(){for(var t=!0,e=0;e<this.events.length;e++)t=t&&this.events[e].checkCompletion();console.log(t);return t},t.Trigger.prototype.operatorOR=function(){for(var t=!1,e=0;e<this.events.length;e++)t=t||this.events[e].checkCompletion();return t},t.Trigger.prototype.operatorXOR=function(){for(var t=!1,e=0;e<this.events.length;e++)if(this.events[e].checkCompletion()){if(t)return!1;t=!0}return t},t.Trigger.prototype.operatorNAND=t.Trigger.prototype.operatorNOT=function(){return!this.operatorAND()},t.Trigger.prototype.operatorNOR=function(){return!this.operatorOR()},t.parseTrigger=function(i){var s=null,n=null;do{for(var o=i.attributes,a=e(i),r=0;r<a.length;r++)a[r]=unescape(a[r]);var h=i.getElementsByTagName("action"),l=null,u=!1,c=!1,d=null;h.length>0&&h[0].parentNode==i&&(l=t.parseAction(h[0])),u=o.getNamedItem("restart")?"true"==o.getNamedItem("restart").value:u,c=o.getNamedItem("detonate")?"true"==o.getNamedItem("detonate").value:c,d=o.getNamedItem("operator")?o.getNamedItem("operator").value:d;var f=new t.Trigger(a,l,null,u,c,d);s||(s=f),n&&(n.followUp=f),n=f;var p=!1;for(r=0;r<i.childNodes.length;r++){var g=i.childNodes[r];if("trigger"==g.nodeName){i=g,p=!0;break}}if(!p)break}while(i);return s},t}((Sburb=function(t){function e(t){var e=t.split(",");return e.map(function(t){return t.trim()}),e}var i={spriteProperty:function(i){var s,n=e(i),o=n[2];o.indexOf(">")>-1&&(s=">")||o.indexOf("GREATER")>-1&&(s="GREATER")?this.trigger=function(t,e,i){return t[e]>i}:o.indexOf("<")>-1&&(s="<")||o.indexOf("LESS")>-1&&(s="LESS")?this.trigger=function(t,e,i){return t[e]<i}:o.indexOf("!=")>-1?(s="!=",this.trigger=function(t,e,i){return t[e]!=i}):o.indexOf("=")>-1&&(s="=",this.trigger=function(t,e,i){return t[e]==i});var a=o.split(s),r=a[0].trim(),h=a[1].trim();this.reset=function(){"char"==n[1]?this.entity=n[1]:this.entity=t.sprites[n[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),this.trigger(e,r,h)}},inBox:function(i){var s=e(i),n=parseInt(s[2]),o=parseInt(s[3]),a=parseInt(s[4]),r=parseInt(s[5]);this.reset=function(){"char"==s[1]?this.entity=s[1]:this.entity=t.sprites[s[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),e.x>=n&&e.y>=o&&e.x<=n+a&&e.y<=o+r}},inBox2:function(t){var s=e(t),n=parseInt(s[2]),o=parseInt(s[3]),a=parseInt(s[4]),r=parseInt(s[5]),h=Math.min(n,a),l=Math.min(o,r),u=Math.abs(n-a),c=Math.abs(o-r);return new i.inBox("inBox,"+s[1]+","+h+","+l+","+u+","+c)},time:function(t){var i=e(t);this.reset=function(){this.time=parseInt(i[1])},this.checkCompletion=function(){return this.time--,this.time<=0},this.serialize=function(){return"time,"+this.time}},played:function(i){var s=e(i);this.reset=function(){this.entity=t.sprites[s[1]]},this.checkCompletion=function(){var e=this.entity;return"char"==this.entity&&(e=t.char),e.animation.hasPlayed()}},movie:function(i){var s=e(i),n=parseInt(s[2]);this.reset=function(){this.movie=window.document.getElementById("movie"+s[1])},this.checkCompletion=function(){return!(!this.movie||this.movie.TotalFrames&&!(this.movie.TotalFrames()>0&&this.movie.TotalFrames()-1-this.movie.CurrentFrame()<=n))&&(t.commands.removeMovie(s[1]),!0)}},gameState:function(i){var s,n=e(i)[1];n.indexOf(">")>-1&&(s=">")||n.indexOf("GREATER")>-1&&(s="GREATER")?this.trigger=function(e,i){return t.gameState[e]>i}:n.indexOf("<")>-1&&(s="<")||n.indexOf("LESS")>-1&&(s="LESS")?this.trigger=function(e,i){return t.gameState[e]<i}:n.indexOf("!=")>-1?(s="!=",this.trigger=function(e,i){return t.gameState[e]!=i}):n.indexOf("=")>-1&&(s="=",this.trigger=function(e,i){return t.gameState[e]==i});var o=n.split(s),a=o[0].trim(),r=o[1].trim();this.reset=function(){},this.checkCompletion=function(){return this.trigger(a,r)}},nudge:function(e){this.reset=function(){},this.checkCompletion=function(){return t.Keys.space||t.Mouse.down}},noActions:function(i){var s=e(i);this.reset=function(){},this.checkCompletion=function(){var e=s.length>0?t.getActionQueueById(s[1]):t;return!e||!e.curAction}},withinRange:function(i){var s=e(i),n=s[1],o=s[2],a=parseFloat(s[3]);this.reset=function(){},this.checkCompletion=function(){var e=t.parseCharacterString(n),i=t.parseCharacterString(o),s=e.x-i.x,r=e.y-i.y;return Math.sqrt(s*s+r*r)<=a}}};return t.events=i,t}((Sburb=function(t){function e(e){if(!e)return"";for(var i=0;i<e.childNodes.length;i++){var s=e.childNodes[i];if("args"==s.tagName){if(s.attributes){var n=s.attributes.getNamedItem("body");if(n&&n.value&&t.assetManager.isLoaded(n.value))return t.assets[n.value]}for(var o=0;o<s.childNodes.length;o++)if(s.childNodes[o].firstChild){serializer=new XMLSerializer;for(var a="",r=0;r<s.childNodes.length;r++)a+=serializer.serializeToString(s.childNodes[r]);return a}return void 0!==s.textContent?s.textContent:s.firstChild.nodeValue}}return void 0!==e.textContent?e.textContent:e.firstChild.nodeValue}return t.Action=function(t,e,i,s,n,o,a,r,h,l){this.sprite=s||null,this.name=i||null,this.command=t,this._info=e,this.followUp=n||null,this.noWait=o||!1,this.noDelay=a||!1,this.soft=h||!1,this.silent="true"==l||(l||!1),this.times=r||1},t.Action.prototype.info=function(){if(this._info){if("string"==typeof this._info)return this._info;if(this._info.text)return this._info.text}return""},t.Action.prototype.clone=function(){return new t.Action(this.command,this._info,this.name,this.sprite,this.followUp,this.noWait,this.noDelay,this.times,this.soft,this.silent)},t.Action.prototype.serialize=function(t){return t=t.concat("\n<action command='"+this.command+(this.sprite?"' sprite='"+this.sprite:"")+(this.name?"' name='"+escape(this.name):"")+(this.noWait?"' noWait='"+this.noWait:"")+(this.noDelay?"' noDelay='"+this.noDelay:"")+(this.soft?"' soft='"+this.soft:"")+(this.silent?"' silent='"+this.silent:"")+(1!=this.times?"' times='"+this.times:"")+"'>"),"string"==typeof this._info?t=t.concat("<args>"+escape(this._info.trim())+"</args>"):this._info.name&&(t=t.concat('<args body="'+this._info.name+'" />')),this.followUp&&(t=this.followUp.serialize(t)),t=t.concat("</action>")},t.parseAction=function(i){var s=null,n=null,o=null;do{var a=i.attributes;a.getNamedItem("sprite")&&"null"!=a.getNamedItem("sprite").value&&(s=a.getNamedItem("sprite").value);var r=a.getNamedItem("times")||a.getNamedItem("loops")||a.getNamedItem("for"),h=i.firstChild?e(i):"";"string"==typeof h&&(h=unescape(h).trim());var l=new t.Action(a.getNamedItem("command").value,h,a.getNamedItem("name")?unescape(a.getNamedItem("name").value):null,s,null,!!a.getNamedItem("noWait")&&"true"==a.getNamedItem("noWait").value,!!a.getNamedItem("noDelay")&&"true"==a.getNamedItem("noDelay").value,r?parseInt(r.value):1,!!a.getNamedItem("soft")&&"true"==a.getNamedItem("soft").value,!!a.getNamedItem("silent")&&a.getNamedItem("silent").value);o&&(o.followUp=l),n||(n=l),o=l;var u=i;i=null;for(var c=0;c<u.childNodes.length;c++){var d=u.childNodes[c];if("action"==d.nodeName){i=d;break}}if(!i)break}while(i);return n},t}((Sburb=function(t){return t.FontEngine=function(t){this.font="bold 14px SburbFont",this.color="#000000",this.text="string"==typeof t?t:"",this.x=0,this.y=0,this.width=999999,this.height=999999,this.start=0,this.end=999999,this.lines=[],this.lineHeight=17,this.charWidth=8,this.align="left",this.formatted=!0,this.formatQueue=[]},t.FontEngine.prototype.prefixColours={aa:"#a10000",aradia:"#a10000",ac:"#416600",nepeta:"#416600",ag:"#005682",vriska:"#005682",at:"#a15000",tavros:"#a15000",ca:"#6a006a",eridan:"#6a006a",cc:"#77003c",feferi:"#77003c",cg:"#626262",karkat:"#626262",ct:"#000056",equius:"#000056",ga:"#008141",kanaya:"#008141",gc:"#008282",terezi:"#008282",ta:"#a1a100",sollux:"#a1a100",tc:"#2b0057",gamzee:"#2b0057",dave:"#e00707",meenah:"#77003c",rose:"#b536da",aranea:"#005682",kankri:"#ff0000",porrim:"#008141",latula:"#008282"},t.FontEngine.prototype.setStyle=function(t,e,i,s){this.font="string"==typeof t?t:this.font,this.color="string"==typeof e?e:this.color,this.lineHeight="number"==typeof i?i:this.lineHeight,this.charWidth="number"==typeof s?s:this.charWidth,this.parseText()},t.FontEngine.prototype.setFormatted=function(t){this.formatted=t},t.FontEngine.prototype.setText=function(t){this.text=t,this.parseEverything()},t.FontEngine.prototype.setAlign=function(t){this.align=t},t.FontEngine.prototype.showSubText=function(t,e){this.start="number"==typeof t?t:this.start,this.end="number"==typeof e?e:this.end},t.FontEngine.prototype.setDimensions=function(t,e,i,s){this.x="number"==typeof t?t:this.x,this.y="number"==typeof e?e:this.y,this.width="number"==typeof i?i:this.width,this.height="number"==typeof s?s:this.height,this.parseText()},t.FontEngine.prototype.parseEverything=function(){this.parseFormatting(),this.parseText()},t.FontEngine.prototype.parseText=function(){t.stage.font=this.font,this.lines=[];var e=0,i=0,s=0;for(e=0;e<this.text.length;e++){if(" "==this.text.charAt(e))i=e;else if("\n"==this.text.charAt(e)){this.lines.push(this.text.substring(s,e)),i=s=e+1;continue}t.stage.measureText(this.text.substring(s,e+1)).width>this.width&&(s==i?(this.lines.push(this.text.substring(s,e)),s=e,i=e):(this.lines.push(this.text.substring(s,i)),i=s=i+1))}this.lines.push(this.text.substring(s,e))},t.FontEngine.prototype.parseFormatting=function(){this.formatQueue=[],this.formatted&&(this.escaped={},this.parsePrefixes(),this.parseEscapes(),this.parseUnderlines(),this.parseColors())},t.FontEngine.prototype.parseEscapes=function(){var t,e=0;do{if((t=this.text.indexOf("/",e))<this.text.length-1&&t>=0){var i=this.text.charAt(t+1);if("/"==i)e=t+1;else{var s=this.escaped[i];s||(s=this.escaped[i]={});for(var n=0,o=0;o<t;o++)this.text.charAt(o)==i&&n++;s[n+1]=!0}}this.text=this.text.substring(0,t)+this.text.substring(t+1,this.text.length)}while(t>=0)},t.FontEngine.prototype.parsePrefixes=function(){var t,e=this.text.split(" ",1)[0];"!"!=e&&(t=e.indexOf("_")>=0?e.substring(0,this.text.indexOf("_")):e.substring(0,2),this.parsePrefix(t)),this.text=this.text.substring(e.length,this.text.length).trim()},t.FontEngine.prototype.parseUnderlines=function(){for(var e=0,i=0,s=0;;){for(;s++,i=this.text.indexOf("_",e),this.escaped._&&this.escaped._[s];)e=i+1;if(-1==i)break;for(var n=!1,o=this.formatQueue.length-1;o>=0;o--)if("underline"==this.formatQueue[o].type&&999999==this.formatQueue[o].maxIndex){this.formatQueue[o].maxIndex=i,n=!0;break}n||this.addToFormatQueue(new t.FormatRange(i,999999,"underline")),this.text=this.text.substring(0,i)+this.text.substring(i+1,this.text.length),this.realignFormatQueue(i,1)}},t.FontEngine.prototype.parseColors=function(){for(var e=0,i=0,s=0;;){for(;s++,i=this.text.indexOf("#",e),this.escaped["#"]&&this.escaped["#"][s];)e=i+1;if(-1==i)break;if(this.text.indexOf("##",e)==i){for(var n=this.formatQueue.length-1;n>=0;n--)if("colour"==this.formatQueue[n].type&&999999==this.formatQueue[n].maxIndex){this.formatQueue[n].maxIndex=i;break}s++,this.text=this.text.substring(0,i)+this.text.substring(i+2,this.text.length),this.realignFormatQueue(i,2)}else this.addToFormatQueue(new t.FormatRange(i,999999,"colour","#"+this.text.substring(i+1,i+7))),this.text=this.text.substring(0,i)+this.text.substring(i+7,this.text.length),this.realignFormatQueue(i,7)}},t.FontEngine.prototype.addToFormatQueue=function(t){for(var e=this.formatQueue.length,i=0;i<this.formatQueue.length;i++)if(this.formatQueue[i].minIndex>t.minIndex){e=i;break}this.formatQueue.splice(e,0,t)},t.FontEngine.prototype.realignFormatQueue=function(t,e){for(var i=0;i<this.formatQueue.length;i++){var s=this.formatQueue[i];s.maxIndex>t&&999999!=s.maxIndex&&(s.maxIndex-=e),s.minIndex>t&&(s.minIndex-=e)}},t.FontEngine.prototype.parsePrefix=function(e){this.formatQueue.push(new t.FormatRange(0,this.text.length,"colour",this.prefixColouration(e)))},t.FontEngine.prototype.prefixColouration=function(t){return this.prefixColours[t.toLowerCase()]?this.prefixColours[t.toLowerCase()]:"#000000"},t.FontEngine.prototype.nextBatch=function(){return this.realignFormatQueue(-1,this.batchLength()),this.lines.splice(0,Math.min(this.lines.length,Math.floor(this.height/this.lineHeight))),this.lines.length},t.FontEngine.prototype.onLastBatch=function(){return Math.floor(this.height/this.lineHeight)>=this.lines.length},t.FontEngine.prototype.draw=function(){var e,i,s,n,o,a,r=0,h=0,l=[];e=0,i=0;for(var u=0;e<Math.floor(this.height/this.lineHeight)&&e<this.lines.length;){t.stage.save(),t.stage.textBaseline="top",t.stage.textAlign=this.align,a=this.lines[e];var c=this.font,d=this.color,f=!1;o=a.length,h<this.formatQueue.length&&this.formatQueue[h].minIndex<=i+r&&(l.push(this.formatQueue[h]),h++);for(var p=l.length-1;p>=0;p--)l[p].maxIndex<=i+r&&l.splice(p,1);for(p=0;p<l.length;p++)"colour"==l[p].type?d=l[p].extra:"underline"==l[p].type?f=!0:"italic"==l[p].type&&(c="italic "+this.font);h<this.formatQueue.length&&this.formatQueue[h].minIndex<i+a.length&&this.formatQueue[h].minIndex<this.end&&(o=Math.min(o,this.formatQueue[h].minIndex-i));for(p=0;p<l.length;p++)l[p].maxIndex<this.end&&(o=Math.min(o,l[p].maxIndex-i));o!=a.length?r+=(n=o)-(s=r):(n=i+a.length<=this.end?a.length:this.end-i,i+r>=this.start?s=r:i+a.length>=this.start?(s=this.start-i+r,u+=t.stage.measureText(a.substring(r,s)).width):(s=r,n=r),r=-1);var g=n-s;if(g>0){var m=this.x+u,y=this.y+e*this.lineHeight;t.stage.font=c,t.stage.strokeStyle=t.stage.fillStyle=d,t.stage.fillText(a.substring(s,n),m,y),u+=t.stage.measureText(a.substring(s,n)).width,f&&s<n&&(.6!=t.stage.lineWidth&&(t.stage.lineWidth=.6),"square"!=t.stage.lineCap&&(t.stage.lineCap="square"),t.stage.beginPath(),t.stage.moveTo(m,y+this.lineHeight-3),t.stage.lineTo(m+g*this.charWidth,y+this.lineHeight-3),t.stage.closePath(),t.stage.stroke())}-1==r&&(i+=this.lines[e].length+1,r=0,u=0,e++),t.stage.restore()}},t.FontEngine.prototype.isShowingAll=function(){return this.end>=this.batchLength()},t.FontEngine.prototype.batchLength=function(){var t,e=0;for(t=0;t<Math.floor(this.height/this.lineHeight)&&t<this.lines.length;t++)e+=this.lines[t].length;return e},t.FontEngine.prototype.showAll=function(){this.end=this.batchLength()+1},t.FormatRange=function(t,e,i,s){this.minIndex=t,this.maxIndex=e,this.type=i,this.extra="string"==typeof s?s:""},t}(Sburb||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{}))||{});